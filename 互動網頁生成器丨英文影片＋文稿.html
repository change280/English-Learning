<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>完整學習網頁生成器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,300&family=Inter:wght@400;500;600;700&family=Material+Symbols+Outlined" rel="stylesheet">
    <style>
        * { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        
        body {
            background: linear-gradient(135deg, #f8fafb 0%, #f0f4f8 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .vocab-word { 
            border-bottom: 2px solid #60a5fa; 
            cursor: pointer; 
            color: #2563eb; 
            font-weight: 600; 
            transition: all 0.2s ease; 
            padding: 2px 4px;
            border-radius: 2px;
        }
        .vocab-word:hover { 
            background-color: #dbeafe;
            border-bottom-color: #2563eb;
        }
        .vocab-word-custom { 
            border-bottom: 2px solid #f87171; 
            cursor: pointer; 
            color: #dc2626; 
            font-weight: 600; 
            transition: all 0.2s ease; 
            padding: 2px 4px;
            border-radius: 2px;
        }
        .vocab-word-custom:hover { 
            background-color: #fee2e2;
            border-bottom-color: #991b1b;
        }
        #floating-card { 
            transition: opacity 0.2s, transform 0.2s ease; 
            pointer-events: none; 
            z-index: 9999;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal { transition: all 0.3s ease-in-out; }
        .modal.hidden { opacity: 0; pointer-events: none; }
        #quiz-modal { transition: all 0.3s ease-in-out; }
        #quiz-modal.hidden { opacity: 0; pointer-events: none; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .selected-word { 
            background-color: #fef3c7; 
            border-bottom: 2px solid #eab308; 
            font-weight: 600;
            padding: 2px 4px;
            border-radius: 2px;
        }
        #selection-popup { 
            transition: all 0.2s ease; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .learning-card {
            transition: all 0.3s ease;
        }
        .learning-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.08);
        }
        
        /* Sticky video styles */
        #video-container.sticky-video {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 480px;
            height: 270px;
            padding-top: 0 !important;
            max-width: 90vw;
            z-index: 1000;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.3), 0 8px 10px -6px rgb(0 0 0 / 0.3);
            border: 2px solid #fff;
        }
        
        #video-container.sticky-video #player {
            pointer-events: auto;
        }

        #floating-close-btn {
            position: fixed;
            top: 45px;
            right: 20px;
            z-index: 1001;
        }

        @media (max-width: 768px) {
            #video-container.sticky-video {
                width: 320px;
                height: 180px;
                right: 10px;
                top: 70px;
            }
            
            #floating-close-btn {
                top: 35px;
                right: 10px;
            }
        }
        
        /* 漢堡選單樣式 */
        #mobile-menu {
            transition: all 0.3s ease;
        }
        #mobile-menu.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .hamburger-line {
            transition: all 0.3s ease;
        }
        #hamburger-btn.active .hamburger-line:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }
        #hamburger-btn.active .hamburger-line:nth-child(2) {
            opacity: 0;
        }
        #hamburger-btn.active .hamburger-line:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -6px);
        }
        /* Ensure Read and Pause buttons are visible in summary mode */
        body.summary-mode .flex.gap-1.items-center {
            display: flex !important;
        }
        
        /* Hide specific segment controls in summary mode */
        body.summary-mode .segment-time-btn,
        body.summary-mode .segment-time-inputs,
        body.summary-mode .segment-edit-btn,
        body.summary-mode .segment-insert-btn {
            display: none !important;
        }

        .header-link-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 6px 8px;
            border-radius: 8px;
        }

        .header-link-item:hover {
            background-color: #f8fafc;
        }
    </style>
</head>
<body class="text-slate-700">

    <nav class="bg-white border-b border-slate-100 sticky top-0 z-40 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <button id="header-links-trigger" class="flex items-center gap-3 text-left rounded-lg px-2 py-1 -ml-2 hover:bg-slate-50 transition" title="點擊開啟連結選單">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
                                <span class="material-symbols-outlined text-white text-xl">school</span>
                            </div>
                            <div class="flex flex-col">
                                <div class="font-bold text-lg text-slate-900">StudyEngine</div>
                                <div class="text-xs text-slate-500">英語學習平台</div>
                            </div>
                        </button>
                        <div id="header-links-menu" class="hidden absolute left-0 mt-2 w-80 bg-white border border-slate-200 rounded-xl shadow-lg z-50 p-3">
                            <div class="text-xs font-semibold text-slate-600 mb-2">新增連結</div>
                            <div class="flex gap-2 mb-2">
                                <input id="header-link-name" type="text" class="w-32 px-2 py-1.5 border border-slate-200 rounded-lg text-xs" placeholder="名稱">
                                <input id="header-link-url" type="url" class="flex-1 px-2 py-1.5 border border-slate-200 rounded-lg text-xs" placeholder="https://...">
                            </div>
                            <div class="flex justify-end mb-3">
                                <button id="header-link-add-btn" class="px-3 py-1.5 rounded-lg bg-blue-600 text-white text-xs font-semibold hover:bg-blue-700">加入</button>
                            </div>
                            <div class="text-xs font-semibold text-slate-600 mb-2">固定連結</div>
                            <div id="header-links-list" class="space-y-1 max-h-48 overflow-auto"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 手機版：漢堡選單 + Export -->
                <div class="flex items-center gap-2 md:hidden">
                    <div class="relative">
                        <button onclick="toggleExportMenu('mobile')" class="px-3 py-2 rounded-lg border border-purple-200 bg-purple-50 hover:bg-purple-100 text-purple-700 transition text-sm font-medium flex items-center gap-1.5">
                            <span class="material-symbols-outlined text-lg">bookmark</span>
                            <span id="selected-count-mobile">0</span>
                        </button>
                        <div id="export-menu-mobile" class="hidden absolute top-full right-0 mt-2 bg-white border border-slate-200 rounded-xl shadow-lg z-50 min-w-max overflow-hidden">
                            <button onclick="copyExportPrompt()" class="w-full px-4 py-2.5 text-left hover:bg-blue-50 border-b border-slate-100 flex items-center gap-2 text-sm" title="複製生成AI指令的Prompt">
                                <span class="material-symbols-outlined text-sm text-blue-600">content_copy</span> <span>複製 Prompt</span>
                            </button>
                            <button onclick="exportSelectedWords()" class="w-full px-4 py-2.5 text-left hover:bg-blue-50 flex items-center gap-2 text-sm" title="下載選中的生字">
                                <span class="material-symbols-outlined text-sm text-blue-600">download</span> <span>下載文字檔</span>
                            </button>
                        </div>
                    </div>
                    <button id="hamburger-btn" onclick="toggleMobileMenu()" class="p-2 rounded-lg border border-slate-200 hover:bg-slate-50 transition">
                        <div class="w-5 h-5 flex flex-col justify-center gap-1">
                            <span class="hamburger-line block w-full h-0.5 bg-slate-600"></span>
                            <span class="hamburger-line block w-full h-0.5 bg-slate-600"></span>
                            <span class="hamburger-line block w-full h-0.5 bg-slate-600"></span>
                        </div>
                    </button>
                </div>
                
                <!-- 桌面版：完整按鈕列 -->
                <div id="action-buttons" class="hidden md:flex items-center gap-2">
                    <button onclick="openModal('video')" class="px-3 py-2 rounded-lg border border-slate-200 hover:border-red-300 hover:bg-red-50 text-slate-600 hover:text-red-600 transition text-sm font-medium" title="匯入影片">
                        <span class="material-symbols-outlined text-lg">play_circle</span>
                    </button>
                    <button onclick="openModal('transcript')" class="px-3 py-2 rounded-lg border border-slate-200 hover:border-green-300 hover:bg-green-50 text-slate-600 hover:text-green-600 transition text-sm font-medium" title="匯入逐字稿">
                        <span class="material-symbols-outlined text-lg">description</span>
                    </button>
                    <button onclick="openModal('vocab')" class="px-3 py-2 rounded-lg border border-slate-200 hover:border-amber-300 hover:bg-amber-50 text-slate-600 hover:text-amber-600 transition text-sm font-medium" title="匯入單字">
                        <span class="material-symbols-outlined text-lg">vocabulary</span>
                    </button>
                    <button onclick="openModal('quiz')" data-export-hide class="px-3 py-2 rounded-lg border border-slate-200 hover:border-indigo-300 hover:bg-indigo-50 text-slate-600 hover:text-indigo-600 transition text-sm font-medium" title="匯入題庫">
                        <span class="material-symbols-outlined text-lg">quiz</span>
                    </button>
                    <div class="h-6 w-px bg-slate-200"></div>
                    <div class="relative">
                        <button onclick="toggleExportMenu('desktop')" class="px-3 py-2 rounded-lg border border-purple-200 bg-purple-50 hover:bg-purple-100 text-purple-700 transition text-sm font-medium flex items-center gap-1.5">
                            <span class="material-symbols-outlined text-lg">bookmark</span>
                            <span id="selected-count">0</span>
                            <span class="material-symbols-outlined text-sm">expand_more</span>
                        </button>
                        <div id="export-menu-desktop" class="hidden absolute top-full right-0 mt-2 bg-white border border-slate-200 rounded-xl shadow-lg z-50 min-w-max overflow-hidden">
                            <button onclick="copyExportPrompt()" class="w-full px-4 py-2.5 text-left hover:bg-blue-50 border-b border-slate-100 flex items-center gap-2 text-sm" title="複製生成AI指令的Prompt">
                                <span class="material-symbols-outlined text-sm text-blue-600">content_copy</span> <span>複製 Prompt</span>
                            </button>
                            <button onclick="exportSelectedWords()" class="w-full px-4 py-2.5 text-left hover:bg-blue-50 flex items-center gap-2 text-sm" title="下載選中的生字">
                                <span class="material-symbols-outlined text-sm text-blue-600">download</span> <span>下載文字檔</span>
                            </button>
                        </div>
                    </div>
                    <button onclick="downloadHTML()" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:shadow-md transition flex items-center gap-2">
                        <span class="material-symbols-outlined text-lg">save_alt</span> Save
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 手機版漢堡選單 -->
        <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-slate-200 shadow-lg">
            <div class="px-4 py-3 space-y-2">
                <button onclick="openModal('video'); toggleMobileMenu();" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg border border-slate-200 hover:bg-red-50 hover:border-red-300 text-slate-700 transition">
                    <span class="material-symbols-outlined text-red-600">play_circle</span>
                    <span class="font-medium">匯入影片</span>
                </button>
                <button onclick="openModal('transcript'); toggleMobileMenu();" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg border border-slate-200 hover:bg-green-50 hover:border-green-300 text-slate-700 transition">
                    <span class="material-symbols-outlined text-green-600">description</span>
                    <span class="font-medium">匯入逐字稿</span>
                </button>
                <button onclick="openModal('vocab'); toggleMobileMenu();" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg border border-slate-200 hover:bg-amber-50 hover:border-amber-300 text-slate-700 transition">
                    <span class="material-symbols-outlined text-amber-600">vocabulary</span>
                    <span class="font-medium">匯入單字</span>
                </button>
                <button onclick="openModal('quiz'); toggleMobileMenu();" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg border border-slate-200 hover:bg-indigo-50 hover:border-indigo-300 text-slate-700 transition">
                    <span class="material-symbols-outlined text-indigo-600">quiz</span>
                    <span class="font-medium">匯入題庫</span>
                </button>
                <div class="h-px bg-slate-200 my-2"></div>
                <button onclick="downloadHTML(); toggleMobileMenu();" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg border border-blue-300 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold hover:shadow-md transition">
                    <span class="material-symbols-outlined">save_alt</span>
                    <span class="font-medium">儲存學習網頁</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-6 py-8 pb-32 space-y-8">
        
        <!-- Video Section (Will be included in export) -->
        <section id="video-section" class="bg-white rounded-2xl p-8 shadow-sm border border-slate-100 learning-card">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold flex items-center gap-3 text-slate-900">
                    <div class="p-2 bg-red-100 rounded-lg">
                        <span class="material-symbols-outlined text-red-600 text-2xl">play_circle</span>
                    </div>
                    影片播放
                </h3>
                <div class="flex items-center gap-2">
                    <button onclick="openModal('video')" class="px-4 py-2 rounded-lg border border-slate-200 bg-slate-50 hover:bg-slate-100 text-slate-700 text-sm font-medium transition flex items-center gap-2">
                        <span class="material-symbols-outlined text-base">edit</span> 更換影片
                    </button>
                    <button onclick="manualToggleSticky()" class="px-4 py-2 rounded-lg border border-blue-200 bg-blue-50 hover:bg-blue-100 text-blue-700 text-sm font-medium transition flex items-center gap-2" title="切換浮動模式">
                        <span class="material-symbols-outlined text-base">picture_in_picture_alt</span> 浮動
                    </button>
                </div>
            </div>
            <div id="video-container" class="relative w-full bg-black rounded-xl overflow-hidden" style="padding-top: 56.25%;">
                <div id="player" class="absolute inset-0"></div>
                <button id="close-sticky-video" class="hidden absolute top-2 right-2 z-10 p-1.5 bg-black/70 hover:bg-black/90 rounded-lg text-white transition">
                </button>
            </div>
            <div id="video-placeholder" class="hidden w-full" style="padding-top: 30%;"></div>
            <p class="text-sm text-slate-600 mt-3">
                點擊時間標籤跳轉，按 Capture 設定當前播放時間
            </p>
        </section>

        <!-- Floating close button -->
        <button id="floating-close-btn" class="hidden p-2 bg-white/95 hover:bg-white rounded-full text-slate-700 hover:text-slate-900 shadow-lg hover:shadow-xl transition-all hover:scale-110">
            <span class="material-symbols-outlined text-xl">close</span>
        </button>

        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Transcript -->
            <main class="lg:w-2/3 bg-white p-8 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h2 id="transcript-title" class="text-2xl font-bold text-slate-900">逐字稿</h2>
                    <button onclick="toggleTranslations()" class="px-3 py-2 rounded-lg border border-slate-200 bg-slate-50 hover:bg-slate-100 text-slate-600 text-sm font-medium transition flex items-center gap-2">
                        <span class="material-symbols-outlined text-base">translate</span> <span id="toggle-btn-text">顯示中文</span>
                    </button>
                </div>
                
                <div id="transcript-content" class="space-y-8 text-lg leading-relaxed text-slate-700">
                    <p class="text-center text-slate-400 py-12">匯入逐字稿後顯示於此...</p>
                </div>
            </main>

            <!-- Vocab + Quiz Sidebar -->
            <aside class="lg:w-1/3">
                <div class="sticky top-24 space-y-6">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 learning-card p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="font-bold text-xl flex items-center gap-3 text-slate-900">
                                <div class="p-2 bg-amber-100 rounded-lg">
                                    <span class="material-symbols-outlined text-amber-600 text-2xl">verified</span>
                                </div>
                                詞彙表
                                <span class="text-sm bg-slate-200 px-2.5 py-1 rounded-full font-semibold" id="vocab-count">0</span>
                            </h3>
                            <button onclick="showAddVocabModal()" class="text-blue-600 hover:bg-blue-50 rounded-full p-2 transition hover:scale-110" title="新增生字">
                                <span class="material-symbols-outlined text-2xl">add_circle</span>
                            </button>
                        </div>
                        <ul id="vocab-list" class="divide-y max-h-[60vh] overflow-y-auto">
                            <li class="text-sm text-slate-400 italic text-center py-8">尚未匯入單字</li>
                        </ul>
                    </div>
                    
                    <div class="bg-gradient-to-br from-blue-500 via-blue-600 to-indigo-600 rounded-2xl p-8 shadow-lg text-white learning-card">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="p-2 bg-white/20 rounded-lg">
                                <span class="material-symbols-outlined text-2xl">quiz</span>
                            </div>
                            <h3 class="font-bold text-xl">知識檢測</h3>
                        </div>
                        <p class="text-blue-100 text-sm mb-6 leading-relaxed">通過測驗鞏固所學，評估學習進度。</p>
                        <button onclick="openQuiz()" class="w-full bg-white text-blue-600 py-3 px-4 rounded-xl font-bold shadow-md hover:shadow-lg hover:bg-blue-50 transition transform hover:scale-[1.02] flex justify-center items-center gap-2">
                            <span class="material-symbols-outlined">play_circle</span>
                            <span>開始測驗</span>
                        </button>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Mobile Floating Action Button for Quiz -->
    <button onclick="openQuiz()" class="lg:hidden fixed bottom-20 right-6 bg-gradient-to-br from-blue-500 to-indigo-600 text-white p-4 rounded-full shadow-xl hover:shadow-2xl hover:scale-110 z-50 flex items-center justify-center transition">
        <span class="material-symbols-outlined text-2xl">quiz</span>
    </button>

    <!-- Bottom Control Bar (Will be kept in export) -->
    <div id="bottom-controls" class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 shadow-lg z-40 px-3 py-3">
        <div class="flex flex-nowrap justify-center gap-2">
            <button id="play-pause-btn" onclick="togglePlayPause()" class="flex items-center gap-1.5 px-4 py-3 rounded-lg bg-gradient-to-r from-red-500 to-red-600 text-white font-semibold shadow-md hover:shadow-lg active:scale-95 transition-all min-h-[44px]">
                <span class="material-symbols-outlined text-xl" id="play-icon">play_arrow</span>
                <span id="play-text" class="hidden sm:inline text-sm">播放</span>
            </button>
            
            <div class="flex items-center rounded-xl border border-slate-300 bg-slate-100 overflow-hidden min-h-[44px]">
                <button onclick="decreaseFontSize()" class="px-3 py-3 text-sm text-slate-700 hover:bg-slate-200 active:bg-slate-300 transition">
                    <span class="material-symbols-outlined text-lg">text_decrease</span>
                </button>
                <div class="w-px h-8 bg-slate-300"></div>
                <button onclick="increaseFontSize()" class="px-3 py-3 text-sm text-slate-700 hover:bg-slate-200 active:bg-slate-300 transition">
                    <span class="material-symbols-outlined text-lg">text_increase</span>
                </button>
            </div>
            
            <div class="flex items-center rounded-xl border border-slate-300 bg-white overflow-hidden min-h-[44px]">
                <button onclick="decreasePlaybackSpeed()" class="px-3 py-3 text-sm text-slate-700 hover:bg-slate-100 active:bg-slate-200 transition">
                    <span class="material-symbols-outlined text-lg">remove</span>
                </button>
                <div class="w-px h-8 bg-slate-300"></div>
                <div class="flex items-center px-3 py-3 text-sm font-bold min-w-[50px] justify-center text-slate-700">
                    <span id="speed-display">1.0x</span>
                </div>
                <div class="w-px h-8 bg-slate-300"></div>
                <button onclick="increasePlaybackSpeed()" class="px-3 py-3 text-sm text-slate-700 hover:bg-slate-100 active:bg-slate-200 transition">
                    <span class="material-symbols-outlined text-lg">add</span>
                </button>
            </div>
            
            <button onclick="toggleTranslations()" class="flex items-center px-4 py-3 rounded-lg border border-blue-300 bg-blue-50 text-blue-700 text-sm font-medium active:bg-blue-100 hover:bg-blue-100 transition min-h-[44px]">
                <span class="material-symbols-outlined text-lg">translate</span> <span id="cn-toggle-text">中文</span>
            </button>
            <button onclick="resetSettings()" class="hidden sm:block px-4 py-3 rounded-lg border border-slate-300 bg-slate-50 text-slate-600 text-sm font-medium hover:bg-slate-100 active:bg-slate-200 transition min-h-[44px]">
                <span class="material-symbols-outlined text-lg">restart_alt</span>
            </button>
        </div>
    </div>

    <!-- Floating Card -->
    <div id="floating-card" class="fixed hidden bg-white rounded-xl shadow-2xl w-80 border z-50"></div>

    <!-- Selection Popup -->
    <div id="selection-popup" class="fixed hidden bg-purple-600 text-white px-4 py-2 rounded-lg shadow-xl z-50 text-sm font-semibold cursor-pointer hover:bg-purple-700 active:scale-95 transition-all">
        <span class="material-symbols-outlined text-base" style="vertical-align: middle;">add_circle</span> 加入生字
    </div>

    <!-- Quiz Modal -->
    <div id="quiz-modal" class="hidden fixed inset-0 z-[60] bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden">
            <div class="p-6 border-b border-gray-100 bg-gray-50">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-blue-600">psychology</span>
                        <h3 class="text-xl font-bold text-slate-800">Knowledge Check</h3>
                    </div>
                    <button onclick="closeQuiz()" class="text-gray-400 hover:text-gray-600 hover:bg-gray-200 rounded-full p-1 transition"><span class="material-symbols-outlined">close</span></button>
                </div>
                <div id="quiz-language-selector" class="hidden flex items-center gap-2 p-3 bg-white border-2 border-slate-200 rounded-lg">
                    <span class="text-sm font-semibold text-slate-700">Quiz Language:</span>
                    <button onclick="selectQuizLanguage('english')" class="px-4 py-2 rounded-lg text-sm font-semibold border-2 transition" id="quiz-select-en">
                        <span class="material-symbols-outlined text-sm align-middle">language</span> English
                    </button>
                    <button onclick="selectQuizLanguage('chinese')" class="px-4 py-2 rounded-lg text-sm font-semibold border-2 transition" id="quiz-select-zh">
                        <span class="material-symbols-outlined text-sm align-middle">translate</span> 中文
                    </button>
                </div>
            </div>
            <div id="quiz-content" class="p-8 overflow-y-auto space-y-8 bg-white"></div>
            <div id="quiz-footer" class="p-6 border-t border-gray-100 bg-gray-50 flex justify-end"></div>
        </div>
    </div>

    <!-- Add Vocab Modal -->
    <div id="add-vocab-modal" class="modal hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl w-full max-w-3xl flex flex-col h-[80vh]">
            <div class="p-5 border-b flex justify-between items-center">
                <h3 class="font-bold text-lg">新增生字</h3>
                <button onclick="closeAddVocabModal()" class="text-gray-400 hover:text-gray-700 rounded p-1">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            
            <div class="p-4 flex-1 flex flex-col gap-3">
                <div id="add-vocab-hint" class="bg-blue-50 text-blue-800 p-3 rounded text-xs">
                    格式：[{ "word": "...", "def": "...", "pos": "n." }, ...]
                </div>
                <textarea id="add-vocab-input" class="flex-1 border rounded p-4 font-mono text-xs resize-none" placeholder='[{"word":"Example","def":"範例","pos":"n."}]'></textarea>
            </div>
            
            <div class="p-4 border-t flex justify-between gap-3">
                <div></div>
                <div class="flex gap-3">
                    <button onclick="closeAddVocabModal()" class="px-4 py-2 rounded border border-slate-300 hover:bg-slate-50 font-medium">Cancel</button>
                    <button onclick="addNewVocabFromJSON()" class="bg-indigo-600 text-white px-6 py-2 rounded font-bold hover:bg-indigo-700">Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->

    <div id="edit-modal" class="modal hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl w-full max-w-4xl flex flex-col h-[85vh]">
            <div class="p-5 border-b flex justify-between items-center">
                <h3 class="font-bold text-lg">編輯逐字稿段落</h3>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-700 rounded p-1">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            
            <div class="p-6 flex-1 flex flex-col gap-4 overflow-y-auto">
                <div class="flex-1 flex flex-col">
                    <label class="font-semibold mb-2 text-sm text-slate-700">英文內容</label>
                    <textarea id="edit-en-input" class="flex-1 border-2 border-slate-300 rounded-lg p-4 font-sans text-base resize-none focus:border-blue-500 focus:outline-none min-h-[200px]" placeholder="輸入英文內容..."></textarea>
                </div>
                
                <div class="flex-1 flex flex-col">
                    <label class="font-semibold mb-2 text-sm text-slate-700">中文翻譯</label>
                    <textarea id="edit-cn-input" class="flex-1 border-2 border-slate-300 rounded-lg p-4 font-sans text-base resize-none focus:border-blue-500 focus:outline-none min-h-[200px]" placeholder="輸入中文翻譯（可選）..."></textarea>
                </div>
                
                <div class="flex flex-col">
                    <label class="font-semibold mb-2 text-sm text-slate-700">時間標記 (秒)</label>
                    <div class="flex items-center gap-3">
                        <input type="number" id="edit-time-input" min="0" step="1" class="w-32 px-3 py-2 border-2 border-blue-300 rounded-lg bg-white text-sm font-semibold text-center focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="0">
                        <span class="text-sm text-slate-600">秒</span>
                        <button onclick="previewEditTime()" class="px-4 py-2 rounded-lg border border-blue-300 bg-blue-50 text-blue-700 text-xs font-semibold hover:bg-blue-100 transition-colors">預覽時間</button>
                    </div>
                </div>
            </div>
            
            <div class="p-4 border-t flex justify-end gap-3">
                <button onclick="closeEditModal()" class="px-6 py-2.5 rounded-lg border border-slate-300 hover:bg-slate-50 font-medium">取消</button>
                <button onclick="saveEdit()" class="bg-blue-600 text-white px-6 py-2.5 rounded-lg font-bold hover:bg-blue-700">儲存</button>
            </div>
        </div>
    </div>

    <!-- Insert Transcript Modal -->
    <div id="insert-modal" class="modal hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl w-full max-w-3xl flex flex-col h-[80vh]">
            <div class="p-5 border-b flex justify-between items-center">
                <h3 class="font-bold text-lg">從段落 <span id="insert-segment-index"></span> 插入逐字稿</h3>
                <div class="flex items-center gap-2">
                    <button id="copy-insert-prompt-btn" onclick="copyInsertPrompt()" class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full border border-indigo-200 bg-indigo-50 text-indigo-700 hover:bg-indigo-100 hover:border-indigo-300 text-xs font-semibold transition" title="複製 AI Prompt">
                        <span class="material-symbols-outlined text-sm">auto_awesome</span>
                        AI Prompt
                    </button>
                    <button onclick="closeInsertModal()" class="text-gray-400 hover:text-gray-700 rounded p-1">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
            </div>
            
            <div class="p-4 flex-1 flex flex-col gap-3">
                <div class="bg-purple-50 text-purple-800 p-3 rounded text-xs">
                    格式：[{ "en": "...", "cn": "...", "t": 0 }, ...]<br>
                    <strong>注意：</strong>此功能會從選定的段落開始，用新資料<strong>取代</strong>之後所有段落，但保留之前的段落。
                </div>
                <textarea id="insert-input" class="flex-1 border rounded p-4 font-mono text-xs resize-none" placeholder='[{"en":"Hello","cn":"你好","t":0}]'></textarea>
            </div>
            
            <div class="p-4 border-t flex justify-end gap-3">
                <button onclick="closeInsertModal()" class="px-4 py-2 rounded hover:bg-gray-100">Cancel</button>
                <button onclick="insertTranscriptFromIndex()" class="bg-purple-600 text-white px-6 py-2 rounded font-bold hover:bg-purple-700">插入逐字稿</button>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="import-modal" class="modal hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl w-full max-w-3xl flex flex-col h-[80vh]">
            <div class="p-5 border-b flex justify-between items-center">
                <h3 class="font-bold text-lg" id="modal-title">Import</h3>
                <div class="flex items-center gap-2">
                    <button id="copy-cefr-prompt-btn" onclick="openCEFRLevelSelector()" class="hidden inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full border border-rose-200 bg-rose-50 text-rose-700 hover:bg-rose-100 hover:border-rose-300 text-xs font-semibold transition" title="複製 CEFR 難度調整 Prompt">
                        <span class="material-symbols-outlined text-sm">tune</span>
                        難度調整
                    </button>
                    <button id="copy-transcript-prompt-btn" onclick="copyTranscriptPromptFromClipboard()" class="hidden inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full border border-emerald-200 bg-emerald-50 text-emerald-700 hover:bg-emerald-100 hover:border-emerald-300 text-xs font-semibold transition" title="複製剪貼簿 Prompt">
                        <span class="material-symbols-outlined text-sm">content_paste</span>
                        剪貼簿 Prompt
                    </button>
                    <button id="copy-prompt-btn" onclick="copyPrompt()" class="hidden inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full border border-indigo-200 bg-indigo-50 text-indigo-700 hover:bg-indigo-100 hover:border-indigo-300 text-xs font-semibold transition" title="複製 AI Prompt">
                        <span class="material-symbols-outlined text-sm">auto_awesome</span>
                        AI Prompt
                    </button>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-700 rounded p-1">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
            </div>
            
            <div class="p-4 flex-1 flex flex-col gap-3">
                <div id="modal-hint" class="bg-blue-50 text-blue-800 p-3 rounded text-xs"></div>
                <textarea id="import-input" class="flex-1 border rounded p-4 font-mono text-xs resize-none"></textarea>
            </div>
            
            <div class="p-4 border-t flex justify-between gap-3">
                <div class="flex gap-2">
                    <button id="clear-data-btn" class="px-4 py-2 rounded border border-red-300 bg-red-50 text-red-700 hover:bg-red-100 font-medium text-sm hidden">
                        <span class="material-symbols-outlined text-base align-middle">delete_outline</span> 清除所有紀錄
                    </button>
                    <button id="clear-all-records-btn" class="px-4 py-2 rounded border border-red-300 bg-red-50 text-red-700 hover:bg-red-100 font-medium text-sm hidden">
                        <span class="material-symbols-outlined text-base align-middle">delete_forever</span> 清除全部資料
                    </button>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeModal()" class="px-4 py-2 rounded hover:bg-gray-100">Cancel</button>
                    <button id="import-action-btn" class="bg-blue-600 text-white px-6 py-2 rounded font-bold">Load</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global State - Load from localStorage
        let transcriptData = JSON.parse(localStorage.getItem('transcriptData') || '[]');
        let vocabData = JSON.parse(localStorage.getItem('vocabData') || '[]');
        let quizData = JSON.parse(localStorage.getItem('quizData') || '[]');
        let quizLanguage = 'english'; // 'english' or 'chinese'
        let videoId = localStorage.getItem('videoId') || '';
        let selectedWords = JSON.parse(localStorage.getItem('selectedWords') || '[]');
        let cefrLevel = localStorage.getItem('cefrLevel') || ''; // Store selected CEFR level
        let translationsVisible = false;
        let player;
        let playerReady = false;
        let headerLinks = JSON.parse(localStorage.getItem('headerLinks') || '[]');
        
        // TTS (Text-to-Speech) State
        let currentSpeakingSegment = null;
        let isSpeechPaused = false;

        // Sticky video functionality
        const videoContainer = document.getElementById('video-container');
        const videoSection = document.getElementById('video-section');
        const videoPlaceholder = document.getElementById('video-placeholder');
        const closeBtn = document.getElementById('close-sticky-video');
        const floatingCloseBtn = document.getElementById('floating-close-btn');
        let isSticky = false;
        let manuallyHidden = false;
        let initialTop = 0;

        // Calculate initial position once
        if (videoSection) {
            setTimeout(() => {
                initialTop = videoSection.getBoundingClientRect().top + window.scrollY;
            }, 100);
        }

        function updateStickyVideo() {
            if (!videoSection || manuallyHidden) return;
            
            const shouldBeSticky = window.scrollY > initialTop + 100;
            
            if (shouldBeSticky && !isSticky) {
                videoContainer.classList.add('sticky-video');
                videoPlaceholder.classList.remove('hidden');
                closeBtn.classList.remove('hidden');
                floatingCloseBtn.classList.remove('hidden');
                isSticky = true;
            } else if (!shouldBeSticky && isSticky) {
                videoContainer.classList.remove('sticky-video');
                videoPlaceholder.classList.add('hidden');
                closeBtn.classList.add('hidden');
                floatingCloseBtn.classList.add('hidden');
                isSticky = false;
            }
        }

        function closeStickyVideo() {
            videoContainer.classList.remove('sticky-video');
            videoPlaceholder.classList.add('hidden');
            closeBtn.classList.add('hidden');
            floatingCloseBtn.classList.add('hidden');
            isSticky = false;
            manuallyHidden = true;
        }

        function manualToggleSticky() {
            if (isSticky) {
                // 如果已經是浮動狀態，關閉它
                closeStickyVideo();
            } else {
                // 開啟浮動模式
                videoContainer.classList.add('sticky-video');
                videoPlaceholder.classList.remove('hidden');
                closeBtn.classList.remove('hidden');
                floatingCloseBtn.classList.remove('hidden');
                isSticky = true;
                manuallyHidden = false;
            }
        }

        closeBtn.addEventListener('click', closeStickyVideo);
        floatingCloseBtn.addEventListener('click', closeStickyVideo);

        window.addEventListener('scroll', updateStickyVideo);
        window.addEventListener('resize', () => {
            if (videoSection && !manuallyHidden) {
                initialTop = videoSection.getBoundingClientRect().top + window.scrollY;
                updateStickyVideo();
            }
        });

        let youtubeAPIReady = false;
        let currentFontSize = 18; // base font size in px
        let currentPlaybackSpeed = 1.0;

        const modal = document.getElementById('import-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalHint = document.getElementById('modal-hint');
        const inputArea = document.getElementById('import-input');
        const actionBtn = document.getElementById('import-action-btn');
        const floatingCard = document.getElementById('floating-card');
        const transcriptPromptBtn = document.getElementById('copy-transcript-prompt-btn');
        const headerLinksTrigger = document.getElementById('header-links-trigger');
        const headerLinksMenu = document.getElementById('header-links-menu');
        const headerLinksList = document.getElementById('header-links-list');
        const headerLinkNameInput = document.getElementById('header-link-name');
        const headerLinkUrlInput = document.getElementById('header-link-url');
        const headerLinkAddBtn = document.getElementById('header-link-add-btn');

        function saveHeaderLinks() {
            localStorage.setItem('headerLinks', JSON.stringify(headerLinks));
        }

        function renderHeaderLinks() {
            if (!headerLinksList) return;
            headerLinksList.innerHTML = '';
            if (headerLinks.length === 0) {
                headerLinksList.innerHTML = '<div class="text-xs text-slate-400">尚未新增連結</div>';
                return;
            }
            headerLinks.forEach((link, index) => {
                const item = document.createElement('div');
                item.className = 'header-link-item';
                item.innerHTML = `
                    <a href="${link.url}" target="_blank" rel="noopener" class="text-xs text-blue-600 hover:text-blue-700 truncate">${link.name}</a>
                    <button class="text-xs text-slate-400 hover:text-red-500" title="移除" data-index="${index}">✕</button>
                `;
                const removeBtn = item.querySelector('button');
                removeBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (confirm(`確定要移除「${link.name}」嗎？`)) {
                        removeHeaderLink(index);
                    }
                });
                headerLinksList.appendChild(item);
            });
        }

        function addHeaderLink() {
            const name = headerLinkNameInput.value.trim();
            const url = headerLinkUrlInput.value.trim();
            if (!name || !url) return;
            headerLinks.push({ name, url });
            saveHeaderLinks();
            renderHeaderLinks();
            headerLinkNameInput.value = '';
            headerLinkUrlInput.value = '';
        }

        function removeHeaderLink(index) {
            headerLinks.splice(index, 1);
            saveHeaderLinks();
            renderHeaderLinks();
        }

        function toggleHeaderLinksMenu() {
            if (!headerLinksMenu) return;
            headerLinksMenu.classList.toggle('hidden');
            if (!headerLinksMenu.classList.contains('hidden')) {
                renderHeaderLinks();
                headerLinkNameInput.focus();
            }
        }

        function closeHeaderLinksMenu() {
            if (!headerLinksMenu) return;
            headerLinksMenu.classList.add('hidden');
        }

        // Modal Functions
        function openModal(mode) {
            modal.classList.remove('hidden');
            inputArea.value = '';
            inputArea.focus();
            const clearBtn = document.getElementById('clear-data-btn');
            const clearAllBtn = document.getElementById('clear-all-records-btn');
            const copyBtn = document.getElementById('copy-prompt-btn');
            const cefrBtn = document.getElementById('copy-cefr-prompt-btn');
            window.currentModalMode = mode;
            
            if (mode === 'video') {
                modalTitle.innerText = "設定 YouTube 影片";
                modalHint.innerText = '貼上 YouTube 網址或影片 ID';
                inputArea.placeholder = 'https://www.youtube.com/watch?v=...';
                actionBtn.onclick = parseVideoUrl;
                clearBtn.classList.add('hidden');
                clearAllBtn.classList.remove('hidden');
                copyBtn.classList.add('hidden');
                transcriptPromptBtn.classList.add('hidden');
                cefrBtn.classList.add('hidden');
                clearAllBtn.onclick = () => {
                    if (confirm('確定要清除所有紀錄嗎？\n\n此操作會清除：影片連結、逐字稿、單字、測驗、摘要模式與選字。')) {
                        clearAllRecords();
                    }
                };
            } else if (mode === 'transcript') {
                modalTitle.innerText = "匯入逐字稿";
                modalHint.innerText = '格式：[{ "en": "...", "cn": "...", "t": 0 }, ...]';
                inputArea.placeholder = '[{"en":"Hello","cn":"你好","t":0}]';
                actionBtn.onclick = parseTranscript;
                clearBtn.classList.remove('hidden');
                clearAllBtn.classList.add('hidden');
                copyBtn.classList.remove('hidden');
                transcriptPromptBtn.classList.remove('hidden');
                cefrBtn.classList.remove('hidden');
                clearBtn.onclick = () => {
                    if (confirm('確定要清除所有逐字稿紀錄嗎？')) {
                        clearTranscriptData();
                    }
                };
            } else if (mode === 'vocab') {
                modalTitle.innerText = "匯入單字";
                modalHint.innerText = '格式：[{ "word": "...", "def": "...", "pos": "n." }, ...]';
                inputArea.placeholder = '[{"word":"Example","def":"範例"}]';
                actionBtn.onclick = parseVocab;
                clearBtn.classList.remove('hidden');
                clearAllBtn.classList.add('hidden');
                copyBtn.classList.remove('hidden');
                transcriptPromptBtn.classList.add('hidden');
                cefrBtn.classList.add('hidden');
                clearBtn.onclick = () => {
                    if (confirm('確定要清除所有單字紀錄嗎？')) {
                        clearVocabData();
                    }
                };
            } else {
                modalTitle.innerText = "匯入 Quiz（雙語格式）";
                modalHint.innerText = '格式：{ "english": [{"q":"...", "options":[...], "correct":0}], "chinese": [{"q":"...", "options":[...], "correct":0}] }';
                inputArea.placeholder = '{"english":[{"q":"Question?","options":["A","B","C","D"],"correct":0}],"chinese":[{"q":"題目?","options":["A","B","C","D"],"correct":0}]}';
                actionBtn.onclick = parseQuiz;
                clearBtn.classList.remove('hidden');
                clearAllBtn.classList.add('hidden');
                copyBtn.classList.remove('hidden');
                transcriptPromptBtn.classList.add('hidden');
                cefrBtn.classList.add('hidden');
                clearBtn.onclick = () => {
                    if (confirm('確定要清除所有 Quiz 題庫嗎？')) {
                        clearQuizData();
                    }
                };
            }
        }

        function closeModal() {
            modal.classList.add('hidden');
        }

        if (headerLinksTrigger) {
            headerLinksTrigger.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleHeaderLinksMenu();
            });
        }

        if (headerLinkAddBtn) {
            headerLinkAddBtn.addEventListener('click', (e) => {
                e.preventDefault();
                addHeaderLink();
            });
        }

        document.addEventListener('click', (e) => {
            if (!headerLinksMenu || headerLinksMenu.classList.contains('hidden')) return;
            const withinMenu = headerLinksMenu.contains(e.target);
            const withinTrigger = headerLinksTrigger && headerLinksTrigger.contains(e.target);
            if (!withinMenu && !withinTrigger) {
                closeHeaderLinksMenu();
            }
        });

        function selectQuizLanguage(lang) {
            quizLanguage = lang;
            updateQuizLanguageSelector();
            renderQuizContent(); // 重新渲染題目
        }

        function updateQuizLanguageSelector() {
            const btnEn = document.getElementById('quiz-select-en');
            const btnZh = document.getElementById('quiz-select-zh');
            
            if (!btnEn || !btnZh) return;
            
            if (quizLanguage === 'english') {
                btnEn.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                btnEn.classList.remove('bg-white', 'text-slate-700', 'border-slate-300');
                btnZh.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
                btnZh.classList.add('bg-white', 'text-slate-700', 'border-slate-300');
            } else {
                btnZh.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                btnZh.classList.remove('bg-white', 'text-slate-700', 'border-slate-300');
                btnEn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
                btnEn.classList.add('bg-white', 'text-slate-700', 'border-slate-300');
            }
        }


        function generateTranscriptPrompt() {
            let prompt = '';
            
            // Add video URL if available
            if (videoId && videoId.length === 11) {
                prompt += `https://www.youtube.com/watch?v=${videoId}\n\n`;
            } else {
                prompt += '🔻\n\n';
            }
            
            prompt += `將以上影片的演講內容，整理成英文和中文隨段落對照的逐字稿，並以以下格式嚴格依照 JSON Array 格式輸出結果：：
{
    en: "When I found out my grandmother, my last living grandparent, was dying, my first thought was, \"I need to draw her hands.\" I'm a visual artist, a cartoonist for The New Yorker, and comics writer, so drawing is how I understand much of the world.",
    cn: "當我得知我的祖母——我最後一位在世的祖父母——即將離世時，我的第一個念頭是：「我需要畫下她的手。」我是一位視覺藝術家，也是《紐約客》的漫畫家和漫畫作者，所以繪畫是我理解這個世界的主要方式。"
},
{
    en: "For a long time, my cartoons had been impersonal. Commentary on the world around me, sure, but not really about me. The closest my personal life got to influencing my cartoons were cartoons I lifted from things my friends and family had said around me. It was only after my daughter Ellika was born that my personal life began to creep into my cartoons more.",
    cn: "很長一段時間以來，我的漫畫都是非個人化的。它們是對周遭世界的評論，沒錯，但並不真正關於我自己。我的個人生活對漫畫最接近的影響，頂多就是從朋友和家人的談話中取材。直到我女兒埃莉卡 (Ellika) 出生後，我的個人生活才開始更多地滲透進我的漫畫中。"
}`;
            
            return prompt;
        }

        function generateQuizPrompt() {
            let prompt = '# Role: 你是一位資深的英語教學評量專家，專精於 CEFR 等級分析與閱讀理解診斷。\n\n';
            prompt += '# Task: 請針對我提供的英文文章，設計一份用於「評估學生閱讀程度」的題組。\n\n';
            prompt += '# Requirements:\n\n';
            prompt += '1. **文章程度診斷**：先簡述這篇文章在 CEFR 標準下屬於哪個等級，並列出 5-10 個影響難度的關鍵詞彙。\n\n';
            prompt += '2. **題組設計**：請根據「閱讀理解三層次」設計 6 道選擇題：\n';
            prompt += '   - Level 1: 字面理解題 (Literal) x 2 (答案直接在文中)\n';
            prompt += '   - Level 2: 推論理解題 (Inferential) x 2 (需要整合上下文或猜測語氣)\n';
            prompt += '   - Level 3: 批判/整合題 (Evaluative) x 2 (需要理解作者核心意圖或延伸思考)\n\n';
            prompt += '3. **讀者程度診斷指南**：這部分最重要。請提供一個對照表，說明學生答對題數所代表的 CEFR 閱讀能力落點，以及後續的學習建議。\n\n';
            prompt += '# Output Format:\n\n';
            prompt += '---\n\n';
            prompt += '## 一、 文章難度分析 (CEFR Level)\n\n';
            prompt += '## 二、 閱讀評估題組 (附選項與正確答案)\n\n';
            prompt += '## 三、 學生程度診斷指南 (Diagnostic Guide)\n\n';
            prompt += '- 答對 0-2 題：程度落點與建議\n';
            prompt += '- 答對 3-4 題：程度落點與建議\n';
            prompt += '- 答對 5-6 題：程度落點與建議\n\n';
            prompt += '---\n\n';
            prompt += 'Please output a JSON object with TWO keys: "english" and "chinese", each containing a JSON Array of questions.\n';
            prompt += 'Format specifications:\n\n';
            prompt += '{\n';
            prompt += '  "english": [\n';
            prompt += '    { "q": "Question in English", "options": ["Option A", "Option B", "Option C", "Option D"], "correct": 0 },\n';
            prompt += '    ...\n';
            prompt += '  ],\n';
            prompt += '  "chinese": [\n';
            prompt += '    { "q": "題目中文翻譯", "options": ["選項A", "選項B", "選項C", "選項D"], "correct": 0 },\n';
            prompt += '    ...\n';
            prompt += '  ]\n';
            prompt += '}\n\n';
            prompt += 'Requirements:\n';
            prompt += '- Both English and Chinese versions must have the SAME questions with the SAME correct answers (index).\n';
            prompt += '- English: questions and options in English\n';
            prompt += '- Chinese: complete translation of questions and options to Traditional Chinese\n';
            prompt += '- Output ONLY the JSON object, no explanations or extra text.\n';
            prompt += '- Questions should cover content comprehension, key details, main idea, and inference.\n';
            prompt += '- Avoid duplicate questions or overly similar options.\n';
            prompt += '- Content must be faithful to the transcript; do not add information not present in it.\n\n';
            prompt += 'English transcript:';
            
            if (transcriptData.length > 0) {
                const englishText = transcriptData.map(seg => seg.en).join(' ');
                prompt += englishText;
            } else {
                prompt += '🔻';
            }
            
            return prompt;
        }

        function generateVocabPrompt() {
            let prompt = '你是一位專業的英語教學專家與程式開發輔助者。請分析我提供的文章，並從中挑選出對讀者可能較難、冷僻或具備學習價值的生字（建議難度 B2-C2 或特定領域術語）。\n\n';
            prompt += '請嚴格依照以下 JSON Array 格式輸出結果：\n\n';
            prompt += '1.  **id**: 單字的全小寫形式。\n';
            prompt += '2.  **word**: 單字的首字母大寫。\n';
            prompt += '3.  **ipa**: 該單字的 IPA 音標。\n';
            prompt += '4.  **pos**: 詞性 (如 noun, verb, adjective)。\n';
            prompt += '5.  **def**: 簡潔的英文定義。\n';
            prompt += '6.  **cn**: 繁體中文解釋 (若有特定語境請一併標註)。\n';
            prompt += '範例格式：\n';
            prompt += '[\n    {\n        "id": "pareidolia",\n        "word": "Pareidolia",\n        "ipa": "/ˌpær.ɪˈdoʊ.li.ə/",\n        "pos": "noun",\n        "def": "The psychological phenomenon of seeing recognizable shapes, especially faces, in random or vague stimuli.",\n        "cn": "幻想性錯覺 (尤指將模糊圖像看作人臉)",\n     }\n]\n\n';
            prompt += '文章內容如下：\n';
            
            // Add English transcript if available
            if (transcriptData.length > 0) {
                const englishText = transcriptData.map(seg => seg.en).join(' ');
                prompt += englishText + '\n\n';
            } else {
                prompt += '🔻\n\n';
            }
            
            return prompt;
        }

        function generateCEFRAdaptationPrompt(targetLevel, options = {}) {
            let prompt = '# Role: 你是一位資深的英語教材編寫專家，擅長根據 CEFR 標準調整文本難度。\n\n';
            prompt += '# Task: 請將我提供的原始逐字稿，改寫為符合 [' + targetLevel + '] 程度的英文文章。\n\n';
            prompt += '# Requirements by CEFR Level:\n';
            prompt += '- 若目標為 **A2/B1**：使用常用單字（核心 2000-3000 字），句子結構以單句為主，避免複雜的子句。\n';
            prompt += '- 若目標為 **B2**：可以使用較具體的描述性動詞，允許出現複合句，但應保持邏輯結構清晰。\n';
            prompt += '- 若目標為 **C1**：保持原始文章的精確性與修飾語，強化學術或文學性的轉折詞。\n\n';
            prompt += '# Guidelines:\n';
            prompt += '1. **結構優化**：將原本雜亂的口語逐字稿整理成邏輯通順的段落。\n';
            prompt += '2. **語氣保留**：保留原作者的核心觀點、故事與情感色彩，不要刪除重要的例子。\n';
            prompt += '3. **詞彙調整**：[針對目標程度，替換掉過於艱澀或過於簡單的詞彙]。\n';
            
            // Add optional guidelines
            if (options.keepNarrative) {
                prompt += '4. **保持敘事結構**：請保持敘事結構，僅簡化單字與文法。\n';
            }
            if (options.keepCulturalRef) {
                prompt += '5. **保留文化典故**：請保留文章中的文化典故，但請用簡單的英文句子補充解釋該典故的意思。\n';
            }
            
            prompt += '6. **輸出格式**：\n';
            prompt += '   - 標題：[為改寫後的文章起一個標題]\n';
            prompt += '   - 本文：[改寫後的文章內容]\n';
            prompt += '   - 關鍵單字表：[列出 5 個符合該程度、且對理解本文至關重要的單字與中解]\n\n';
            prompt += '# Target Level: ' + targetLevel + '\n\n';
            prompt += '# Original Transcript (原始逐字稿):\n';
            
            if (transcriptData.length > 0) {
                const englishText = transcriptData.map(seg => seg.en).join(' ');
                prompt += englishText;
            } else {
                prompt += '🔻';
            }
            
            return prompt;
        }

        async function openCEFRLevelSelector() {
            // Create a modal for selecting CEFR level with checkboxes
            const levelHTML = `
                <div id="cefr-level-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 9999;">
                    <div style="background: white; border-radius: 16px; padding: 32px; text-align: left; box-shadow: 0 20px 25px rgba(0,0,0,0.15); max-width: 450px;">
                        <h3 style="font-size: 20px; font-weight: bold; margin-bottom: 24px; color: #1f2937; text-align: center;">選擇目標難度等級</h3>
                        
                        <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px;">
                            <button onclick="copyCEFRPrompt('A2')" style="padding: 12px 24px; border: 2px solid #60a5fa; background: #dbeafe; color: #2563eb; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.2s;">
                                A2 (Elementary)
                            </button>
                            <button onclick="copyCEFRPrompt('B1')" style="padding: 12px 24px; border: 2px solid #60a5fa; background: #dbeafe; color: #2563eb; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.2s;">
                                B1 (Intermediate)
                            </button>
                            <button onclick="copyCEFRPrompt('B2')" style="padding: 12px 24px; border: 2px solid #60a5fa; background: #dbeafe; color: #2563eb; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.2s;">
                                B2 (Upper-Intermediate)
                            </button>
                            <button onclick="copyCEFRPrompt('C1')" style="padding: 12px 24px; border: 2px solid #60a5fa; background: #dbeafe; color: #2563eb; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.2s;">
                                C1 (Advanced)
                            </button>
                        </div>
                        
                        <div style="border-top: 2px solid #e5e7eb; padding-top: 24px; margin-bottom: 24px;">
                            <p style="font-size: 14px; font-weight: bold; color: #4b5563; margin-bottom: 12px;">額外選項 (可複選)：</p>
                            <label style="display: flex; align-items: center; margin-bottom: 12px; cursor: pointer;">
                                <input type="checkbox" id="cefr-narrative-checkbox" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                                <span style="color: #374151; font-size: 14px;">保持敘事結構</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="cefr-cultural-checkbox" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                                <span style="color: #374151; font-size: 14px;">保留文化典故</span>
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 12px;">
                            <button onclick="closeCEFRModal()" style="flex: 1; padding: 12px 24px; border: 2px solid #d1d5db; background: #f3f4f6; color: #6b7280; border-radius: 8px; font-weight: bold; cursor: pointer;">
                                取消
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', levelHTML);
        }

        function closeCEFRModal() {
            const modal = document.getElementById('cefr-level-modal');
            if (modal) modal.remove();
        }

        async function copyCEFRPrompt(level) {
            // Get checkbox states before closing modal
            const narrativeCheckbox = document.getElementById('cefr-narrative-checkbox');
            const culturalCheckbox = document.getElementById('cefr-cultural-checkbox');
            
            const options = {
                keepNarrative: narrativeCheckbox ? narrativeCheckbox.checked : false,
                keepCulturalRef: culturalCheckbox ? culturalCheckbox.checked : false
            };
            
            closeCEFRModal();
            
            try {
                // Try to read from clipboard first
                let clipboardText = '';
                try {
                    clipboardText = await navigator.clipboard.readText();
                } catch (e) {
                    console.warn('無法讀取剪貼簿，將使用應用中的逐字稿');
                }
                
                // Build the CEFR prompt with clipboard content or app data
                let prompt = '# Role: 你是一位資深的英語教材編寫專家，擅長根據 CEFR 標準調整文本難度。\n\n';
                prompt += '# Task: 請將我提供的原始逐字稿，改寫為符合 [' + level + '] 程度的英文文章。\n\n';
                prompt += '# Requirements by CEFR Level:\n';
                prompt += '- 若目標為 **A2/B1**：使用常用單字（核心 2000-3000 字），句子結構以單句為主，避免複雜的子句。\n';
                prompt += '- 若目標為 **B2**：可以使用較具體的描述性動詞，允許出現複合句，但應保持邏輯結構清晰。\n';
                prompt += '- 若目標為 **C1**：保持原始文章的精確性與修飾語，強化學術或文學性的轉折詞。\n\n';
                prompt += '# Guidelines:\n';
                prompt += '1. **結構優化**：將原本雜亂的口語逐字稿整理成邏輯通順的段落。\n';
                prompt += '2. **語氣保留**：保留原作者的核心觀點、故事與情感色彩，不要刪除重要的例子。\n';
                prompt += '3. **詞彙調整**：[針對目標程度，替換掉過於艱澀或過於簡單的詞彙]。\n';
                
                if (options.keepNarrative) {
                    prompt += '4. **保持敘事結構**：請保持敘事結構，僅簡化單字與文法。\n';
                }
                if (options.keepCulturalRef) {
                    prompt += '5. **保留文化典故**：請保留文章中的文化典故，但請用簡單的英文句子補充解釋該典故的意思。\n';
                }
                
                prompt += '6. **輸出格式**：\n';
                prompt += '   - 標題：[為改寫後的文章起一個標題]\n';
                prompt += '   - 本文：[改寫後的文章內容]\n';
                prompt += '   - 關鍵單字表：[列出 5 個符合該程度、且對理解本文至關重要的單字與中解]\n\n';
                prompt += '# Target Level: ' + level + '\n\n';
                prompt += '# Original Transcript (原始逐字稿):\n';
                
                // Use clipboard content if available, otherwise use app data
                if (clipboardText.trim().length > 0) {
                    prompt += clipboardText;
                } else if (transcriptData.length > 0) {
                    const englishText = transcriptData.map(seg => seg.en).join(' ');
                    prompt += englishText;
                } else {
                    prompt += '🔻';
                }
                
                await navigator.clipboard.writeText(prompt);
                
                // Save CEFR level to localStorage
                localStorage.setItem('cefrLevel', level);
                cefrLevel = level;
                
                // Enable summary mode - hide segment controls
                document.body.classList.add('summary-mode');
                
                // Update transcript title
                const transcriptTitle = document.getElementById('transcript-title');
                if (transcriptTitle) {
                    transcriptTitle.textContent = `摘要（${level}）`;
                }
                
                alert(`✅ CEFR ${level} 難度調整 Prompt 已複製到剪貼簿\n摘要標題已更新為：摘要（${level}）\n分段按鈕已隱藏`);
                console.log(`✅ CEFR ${level} Prompt已複製，標題已更新為：摘要（${level}），進入摘要模式`);
            } catch (err) {
                console.error('複製失敗:', err);
                alert('複製失敗，請重試');
            }
        }

        function copyPrompt() {
            let promptText = '';
            
            if (window.currentModalMode === 'transcript') {
                promptText = generateTranscriptPrompt();
            } else if (window.currentModalMode === 'vocab') {
                promptText = generateVocabPrompt();
            } else if (window.currentModalMode === 'quiz') {
                promptText = generateQuizPrompt();
            }
            
            if (!promptText) {
                alert('無法生成prompt');
                return;
            }
            
            navigator.clipboard.writeText(promptText).then(() => {
                const copyBtn = document.getElementById('copy-prompt-btn');
                const originalHTML = copyBtn.innerHTML;
                copyBtn.innerHTML = '<span class="material-symbols-outlined">done</span>';
                copyBtn.style.color = '#10b981';
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalHTML;
                    copyBtn.style.color = '';
                }, 2000);
                
                console.log('✅ Prompt已複製到剪貼簿');
            }).catch(err => {
                console.error('複製失敗:', err);
                alert('複製失敗，請重試');
            });
        }

        async function copyTranscriptPromptFromClipboard() {
            try {
                const clipboardText = await navigator.clipboard.readText();
                const sourceText = clipboardText.trim() ? clipboardText.trim() : '🔻';
                const promptText = `${sourceText}

將以上未經整理的文稿內容，整理成英文和中文隨段落對照的逐字稿，並以以下格式嚴格依照 JSON Array 格式輸出結果：：
{
    en: "When I found out my grandmother, my last living grandparent, was dying, my first thought was, \"I need to draw her hands.\" I'm a visual artist, a cartoonist for The New Yorker, and comics writer, so drawing is how I understand much of the world.",
    cn: "當我得知我的祖母——我最後一位在世的祖父母——即將離世時，我的第一個念頭是：「我需要畫下她的手。」我是一位視覺藝術家，也是《紐約客》的漫畫家和漫畫作者，所以繪畫是我理解這個世界的主要方式。"
},
{
    en: "For a long time, my cartoons had been impersonal. Commentary on the world around me, sure, but not really about me. The closest my personal life got to influencing my cartoons were cartoons I lifted from things my friends and family had said around me. It was only after my daughter Ellika was born that my personal life began to creep into my cartoons more.",
    cn: "很長一段時間以來，我的漫畫都是非個人化的。它們是對周遭世界的評論，沒錯，但並不真正關於我自己。我的個人生活對漫畫最接近的影響，頂多就是從朋友和家人的談話中取材。直到我女兒埃莉卡 (Ellika) 出生後，我的個人生活才開始更多地滲透進我的漫畫中。"
}`;

                await navigator.clipboard.writeText(promptText);
                const originalHTML = transcriptPromptBtn.innerHTML;
                transcriptPromptBtn.innerHTML = '<span class="material-symbols-outlined text-base align-middle">done</span> 已複製';
                transcriptPromptBtn.classList.remove('bg-blue-50', 'text-blue-700');
                transcriptPromptBtn.classList.add('bg-emerald-50', 'text-emerald-700');

                setTimeout(() => {
                    transcriptPromptBtn.innerHTML = originalHTML;
                    transcriptPromptBtn.classList.remove('bg-emerald-50', 'text-emerald-700');
                    transcriptPromptBtn.classList.add('bg-blue-50', 'text-blue-700');
                }, 2000);
            } catch (err) {
                console.error('讀取或複製剪貼簿失敗:', err);
                alert('無法讀取剪貼簿內容，請允許瀏覽器存取剪貼簿後重試。');
            }
        }

        function parseJSON(str) {
            str = str.trim();
            // 如果不是 [ 或 { 開頭，假設為陣列並加上 []
            if (!str.startsWith('[') && !str.startsWith('{')) {
                str = '[' + str + ']';
            }
            return JSON.parse(str);
        }

        function parseVideoUrl() {
            try {
                const input = inputArea.value.trim();
                let id = input;
                
                let m = input.match(/[?&]v=([^&]+)/);
                if (m) id = m[1];
                
                m = input.match(/youtu\.be\/([^?]+)/);
                if (m) id = m[1];
                
                id = id.split('&')[0].split('?')[0];
                
                if (id.length !== 11) throw new Error("無效的影片 ID");
                
                // Save to localStorage
                localStorage.setItem('videoId', id);
                
                // Clear selected words when setting new video
                selectedWords = [];
                localStorage.setItem('selectedWords', JSON.stringify(selectedWords));
                
                console.log(`✅ 影片設定為: ${id}`);
                console.log(`✅ 已清空選取的生字，即將重新整理頁面...`);
                
                // Reload page to reset everything
                setTimeout(() => {
                    location.reload();
                }, 500);
            } catch (e) {
                console.error("錯誤: " + e.message);
            }
        }

        function parseTranscript() {
            try {
                const data = parseJSON(inputArea.value);
                if (!Array.isArray(data)) throw new Error("必須是陣列");
                
                // Auto-add "t" field if missing (set to 0 or incremental)
                data.forEach((item, index) => {
                    if (!item.hasOwnProperty('t')) {
                        item.t = index * 10; // Default: 10 seconds apart
                    }
                });
                
                transcriptData = data;
                localStorage.setItem('transcriptData', JSON.stringify(transcriptData));
                
                // Clear CEFR level when importing new transcript
                localStorage.removeItem('cefrLevel');
                cefrLevel = '';
                document.body.classList.remove('summary-mode');
                const transcriptTitle = document.getElementById('transcript-title');
                if (transcriptTitle) {
                    transcriptTitle.textContent = '逐字稿';
                }
                
                renderTranscript();
                closeModal();
            } catch (e) {
                console.error("格式錯誤: " + e.message);
                alert("匯入失敗：" + e.message + "\n\n請確認 JSON 格式正確");
            }
        }

        function parseVocab() {
            try {
                const data = parseJSON(inputArea.value);
                if (!Array.isArray(data)) throw new Error("必須是陣列");
                vocabData = data;
                localStorage.setItem('vocabData', JSON.stringify(vocabData));
                renderTranscript();
                renderVocab();
                closeModal();
            } catch (e) {
                console.error("格式錯誤: " + e.message);
            }
        }

        function parseQuiz() {
            try {
                const inputValue = inputArea.value.trim();
                if (!inputValue) {
                    alert('請輸入 Quiz 資料');
                    return;
                }
                
                const data = parseJSON(inputValue);
                
                // 檢查是否為雙語格式 { english: [...], chinese: [...] }
                if (typeof data === 'object' && data !== null && !Array.isArray(data) && 'english' in data && 'chinese' in data) {
                    // 雙語格式
                    if (!Array.isArray(data.english) || !Array.isArray(data.chinese)) {
                        alert("錯誤：english 和 chinese 都必須是陣列");
                        return;
                    }
                    if (data.english.length === 0 && data.chinese.length === 0) {
                        alert("錯誤：題庫不能為空");
                        return;
                    }
                    quizData = data; // 保存整個雙語物件
                    localStorage.setItem('quizData', JSON.stringify(quizData));
                    closeModal();
                    alert(`✅ 雙語 Quiz 題庫已匯入\n\n英文：${data.english.length} 題\n中文：${data.chinese.length} 題`);
                    console.log(`✅ 雙語 Quiz 題庫已匯入: 英文 ${data.english.length} 題、中文 ${data.chinese.length} 題`);
                } else if (Array.isArray(data)) {
                    // 傳統格式 - 單一陣列
                    if (data.length === 0) {
                        alert("錯誤：題庫不能為空");
                        return;
                    }
                    quizData = data;
                    localStorage.setItem('quizData', JSON.stringify(quizData));
                    closeModal();
                    alert(`✅ Quiz 題庫已匯入：${quizData.length} 題`);
                    console.log(`✅ Quiz 題庫已匯入: ${quizData.length} 題`);
                } else {
                    alert("格式錯誤：必須是陣列或雙語物件\n\n正確格式：\n{ \"english\": [...], \"chinese\": [...] }\n或\n[{\"q\":\"...\", \"options\":[...], \"correct\":0}]");
                }
            } catch (e) {
                alert("格式錯誤：" + e.message + "\n\n請確認 JSON 格式是否正確");
                console.error("格式錯誤: ", e);
            }
        }

        function clearTranscriptData() {
            transcriptData = [];
            selectedWords = [];
            localStorage.setItem('transcriptData', JSON.stringify(transcriptData));
            localStorage.setItem('selectedWords', JSON.stringify(selectedWords));
            
            // Clear CEFR level and exit summary mode
            localStorage.removeItem('cefrLevel');
            cefrLevel = '';
            document.body.classList.remove('summary-mode');
            
            console.log('✅ 逐字稿紀錄已清除');
            setTimeout(() => location.reload(), 500);
        }

        function clearAllRecords() {
            transcriptData = [];
            vocabData = [];
            quizData = [];
            selectedWords = [];
            videoId = '';
            cefrLevel = '';

            localStorage.removeItem('transcriptData');
            localStorage.removeItem('vocabData');
            localStorage.removeItem('quizData');
            localStorage.removeItem('selectedWords');
            localStorage.removeItem('videoId');
            localStorage.removeItem('cefrLevel');

            document.body.classList.remove('summary-mode');

            console.log('✅ 所有紀錄已清除');
            setTimeout(() => location.reload(), 500);
        }

        function clearVocabData() {
            vocabData = [];
            localStorage.setItem('vocabData', JSON.stringify(vocabData));
            console.log('✅ 單字紀錄已清除');
            setTimeout(() => location.reload(), 500);
        }

        function clearQuizData() {
            quizData = [];
            localStorage.setItem('quizData', JSON.stringify(quizData));
            console.log('✅ Quiz 題庫已清除');
            setTimeout(() => location.reload(), 500);
        }

        // Render Functions
        function renderTranscript() {
            const container = document.getElementById('transcript-content');
            if (transcriptData.length === 0) return;
            
            container.innerHTML = "";
            const sortedVocab = [...vocabData].sort((a,b) => b.word.length - a.word.length);

            transcriptData.forEach((seg, idx) => {
                let text = seg.en;  // 保持純文本進行替換
                
                // 先進行所有替換，建立標記列表
                const replacements = [];
                
                // Collect all vocab replacements
                sortedVocab.forEach(v => {
                    const roots = v.roots || [v.word];
                    const pattern = roots.map(r => r.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|');
                    const regex = new RegExp(`\\b(${pattern})\\b`, 'gi');
                    let match;
                    while ((match = regex.exec(text)) !== null) {
                        replacements.push({
                            start: match.index,
                            end: match.index + match[0].length,
                            word: match[0],
                            vocab: v,
                            type: 'vocab'
                        });
                    }
                });
                
                // Collect all selected word replacements
                selectedWords.forEach(word => {
                    const escaped = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const regex = new RegExp(`\\b(${escaped})\\b`, 'gi');
                    let match;
                    while ((match = regex.exec(text)) !== null) {
                        replacements.push({
                            start: match.index,
                            end: match.index + match[0].length,
                            word: match[0],
                            selectedWord: word,
                            type: 'selected'
                        });
                    }
                });
                
                // Sort by start position (descending) to replace from end to start
                replacements.sort((a, b) => b.start - a.start);
                
                // Remove overlapping replacements (keep the first one found)
                const finalReplacements = [];
                replacements.forEach(rep => {
                    const overlaps = finalReplacements.some(r => 
                        (rep.start >= r.start && rep.start < r.end) ||
                        (rep.end > r.start && rep.end <= r.end)
                    );
                    if (!overlaps) {
                        finalReplacements.push(rep);
                    }
                });
                
                // Apply replacements from end to start
                let html = text;
                finalReplacements.forEach(rep => {
                    const before = html.substring(0, rep.start);
                    const after = html.substring(rep.end);
                    let replacement = '';
                    
                    if (rep.type === 'vocab') {
                        const isCustom = rep.vocab.custom ? 'vocab-word-custom' : 'vocab-word';
                        replacement = `<span class="${isCustom}" data-id="${rep.vocab.id || rep.vocab.word}" 
                                           onmouseenter="showCard(event, '${rep.vocab.id || rep.vocab.word}')" 
                                           onmouseleave="hideCard()" 
                                           onclick="toggleCard(event, '${rep.vocab.id || rep.vocab.word}')">${rep.word}</span>`;
                    } else if (rep.type === 'selected') {
                        replacement = `<span class="selected-word" onclick="removeSelectedWord('${rep.selectedWord}')" style="cursor: pointer; text-decoration: underline;" title="點擊取消選取">${rep.word}</span>`;
                    }
                    
                    html = before + replacement + after;
                });

                const hasTime = typeof seg.t === 'number';
                const timeLabel = hasTime ? formatTime(seg.t) : 'Set';
                const timeClass = hasTime ? 'bg-green-50 text-green-700' : 'bg-slate-100 text-slate-600';
                const minutes = hasTime ? Math.floor(seg.t / 60) : '';
                const seconds = hasTime ? seg.t % 60 : '';

                container.innerHTML += `
                    <div class="mb-6" id="seg-${idx}">
                        <div class="flex gap-2 mb-2 flex-wrap items-center">
                            ${cefrLevel ? `<div class="flex gap-1 items-center">
                                <button class="px-3 py-1.5 rounded-lg border-2 border-indigo-200 bg-indigo-50 text-indigo-700 text-xs font-semibold hover:bg-indigo-100 transition-colors" 
                                        onclick="speakSegment(${idx})" title="播放此段落">
                                    🔊 Read
                                </button>
                                <button id="pause-btn-${idx}" class="px-3 py-1.5 rounded-lg border-2 border-indigo-200 bg-indigo-50 text-indigo-700 text-xs font-semibold hover:bg-indigo-100 transition-colors opacity-50" 
                                        onclick="togglePauseSegment(${idx})" title="暫停/繼續播放" style="cursor: not-allowed;">
                                    ⏸ Pause
                                </button>
                            </div>` : ''}
                            <button class="segment-time-btn px-3 py-1.5 rounded-lg border-2 ${timeClass} text-xs font-semibold transition-colors" 
                                    onclick="jumpToTime(${hasTime ? seg.t : 'null'})">
                                ⏵ ${timeLabel}
                            </button>
                            <div class="segment-time-inputs flex items-center gap-0 bg-blue-50 rounded-lg border-2 border-blue-200 overflow-hidden">

                                <div class="flex items-center gap-0.5 px-2 py-1.5">
                                    <input type="number" id="min-input-${idx}" min="0" max="999" step="1" 
                                           class="w-14 px-2 py-0.5 rounded border border-blue-300 bg-white text-sm font-semibold text-center focus:outline-none focus:ring-2 focus:ring-blue-400"
                                           placeholder="0" value="${minutes}"
                                           onchange="setTimeByInput(${idx})"
                                           onkeypress="if(event.key==='Enter') setTimeByInput(${idx})">
                                    <span class="text-xs font-bold text-blue-700">:</span>
                                    <input type="number" id="sec-input-${idx}" min="0" max="59" step="1" 
                                           class="w-14 px-2 py-0.5 rounded border border-blue-300 bg-white text-sm font-semibold text-center focus:outline-none focus:ring-2 focus:ring-blue-400"
                                           placeholder="00" value="${seconds ? String(seconds).padStart(2, '0') : ''}"
                                           onchange="setTimeByInput(${idx})"
                                           onkeypress="if(event.key==='Enter') setTimeByInput(${idx})">
                                <div class="h-6 w-px bg-blue-200 ml-3"></div>
                                <button class="px-3 py-1.5 text-blue-700 text-xs font-semibold hover:bg-blue-100 transition-colors flex items-center" 
                                        onclick="captureTime(${idx})">
                                    📹 Capture
                                </button>
                                   </div>
                            </div>
                            <button class="segment-edit-btn px-3 py-1.5 rounded-lg border-2 border-amber-200 bg-amber-50 text-amber-700 text-xs font-semibold hover:bg-amber-100 transition-colors" 
                                    onclick="editSegment(${idx})">
                                ✏️ Edit
                            </button>
                            <button class="segment-insert-btn px-3 py-1.5 rounded-lg border-2 border-purple-200 bg-purple-50 text-purple-700 text-xs font-semibold hover:bg-purple-100 transition-colors" 
                                    onclick="openInsertModal(${idx})" 
                                    title="從此段落開始插入新逐字稿">
                                <span class="material-symbols-outlined text-sm align-middle">add_box</span> Insert
                            </button>
                        </div>
                        <p class="mb-2 text-slate-800 leading-relaxed" id="en-${idx}">${html}</p>
                        ${seg.cn ? `<p class="cn-text hidden text-slate-600 pl-4 border-l-4 border-blue-200 italic text-base" id="cn-${idx}">${seg.cn}</p>` : ''}
                    </div>`;
            });
            
            applyTranslationState();
        }

        function showAddVocabModal() {
            document.getElementById('add-vocab-modal').classList.remove('hidden');
            document.getElementById('add-vocab-input').focus();
        }

        function closeAddVocabModal() {
            document.getElementById('add-vocab-modal').classList.add('hidden');
            // 清空表單
            document.getElementById('add-vocab-input').value = '';
        }

        function addNewVocabFromJSON() {
            try {
                const input = document.getElementById('add-vocab-input').value.trim();
                if (!input) {
                    alert('請輸入單字資料');
                    return;
                }
                
                const data = parseJSON(input);
                if (!Array.isArray(data)) {
                    alert('格式錯誤：必須是陣列');
                    return;
                }
                
                if (data.length === 0) {
                    alert('請至少新增一個單字');
                    return;
                }
                
                let addedCount = 0;
                data.forEach(item => {
                    if (!item.word) return; // 跳過沒有 word 的項目
                    
                    // 檢查是否重複
                    if (vocabData.some(v => v.word.toLowerCase() === item.word.toLowerCase())) {
                        console.warn(`⚠️ 單字已存在，已跳過: ${item.word}`);
                        return;
                    }
                    
                    // 添加新單字（標記為自訂：custom: true）
                    const newVocab = {
                        id: item.word.toLowerCase(),
                        word: item.word.charAt(0).toUpperCase() + item.word.slice(1).toLowerCase(),
                        def: item.def || '',
                        cn: item.cn || '',
                        pos: item.pos || '',
                        custom: true  // 標記為自訂單字
                    };
                    
                    vocabData.push(newVocab);
                    addedCount++;
                });
                
                if (addedCount === 0) {
                    alert('所有單字都已存在或格式不正確');
                    return;
                }
                
                localStorage.setItem('vocabData', JSON.stringify(vocabData));
                renderVocab();
                renderTranscript();
                closeAddVocabModal();
                
                alert(`✅ 已新增 ${addedCount} 個生字`);
                console.log(`✅ 已新增 ${addedCount} 個生字`);
            } catch (e) {
                alert('格式錯誤：' + e.message + '\n\n請確認 JSON 格式是否正確');
                console.error('格式錯誤: ', e);
            }
        }

        function renderVocab() {
            const list = document.getElementById('vocab-list');
            const count = document.getElementById('vocab-count');
            
            if (vocabData.length === 0) return;
            
            count.textContent = vocabData.length;
            list.innerHTML = "";
            
            const sortedVocab = [...vocabData].sort((a,b) => a.word.localeCompare(b.word));
            sortedVocab.forEach((v, index) => {
                list.innerHTML += `
                    <li class="p-4 hover:bg-blue-50 cursor-pointer border-b border-slate-200 last:border-b-0" 
                        onclick="scrollToVocab('${v.id || v.word}')">
                        <div class="flex items-start gap-3 mb-2">
                            <div class="text-sm font-bold text-slate-400 flex-shrink-0">${index + 1}.</div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2">
                                    <div class="font-bold text-base">${v.word}</div>
                                    <button onclick="event.stopPropagation(); speakWord('${v.word}')" class="text-slate-400 hover:text-blue-600 transition" title="播放發音">
                                        <span class="material-symbols-outlined text-sm">volume_up</span>
                                    </button>
                                </div>
                                ${v.ipa ? `<div class="text-xs text-blue-600 font-semibold mt-1">${v.ipa}</div>` : ''}
                                ${v.pos ? `<div class="text-xs text-slate-500 mt-0.5">${v.pos}</div>` : ''}
                            </div>
                        </div>
                        <div class="text-xs text-slate-600 mb-2 ml-6">${v.def || ''}</div>
                        ${v.cn ? `<div class="text-xs text-blue-700 font-semibold ml-6">${v.cn}</div>` : ''}
                    </li>`;
            });
        }
        
        function speakWord(word) {
            // 使用 Web Speech API 播放發音
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(word);
                utterance.lang = 'en-US';
                utterance.rate = 1;
                utterance.pitch = 1;
                speechSynthesis.speak(utterance);
            } else {
                console.warn('您的瀏覽器不支援語音合成功能');
            }
        }

        function speakSegment(segmentIndex) {
            // 播放特定段落的英文文本
            if (segmentIndex < 0 || segmentIndex >= transcriptData.length) return;
            
            const segment = transcriptData[segmentIndex];
            if (!segment.en) return;
            
            if ('speechSynthesis' in window) {
                // 如果當前正在播放同一段落
                if (currentSpeakingSegment === segmentIndex) {
                    if (isSpeechPaused) {
                        // 恢復播放
                        speechSynthesis.resume();
                        isSpeechPaused = false;
                        updatePauseButton(segmentIndex, false);
                    } else {
                        // 暫停播放
                        speechSynthesis.pause();
                        isSpeechPaused = true;
                        updatePauseButton(segmentIndex, true);
                    }
                } else {
                    // 播放新段落
                    speechSynthesis.cancel();
                    currentSpeakingSegment = segmentIndex;
                    isSpeechPaused = false;
                    
                    const utterance = new SpeechSynthesisUtterance(segment.en);
                    utterance.lang = 'en-US';
                    utterance.rate = 1;
                    utterance.pitch = 1;
                    
                    // 播放結束時重置狀態
                    utterance.onend = () => {
                        currentSpeakingSegment = null;
                        isSpeechPaused = false;
                        updatePauseButton(segmentIndex, false);
                    };
                    
                    speechSynthesis.speak(utterance);
                    updatePauseButton(segmentIndex, false);
                }
            } else {
                console.warn('您的瀏覽器不支援語音合成功能');
            }
        }
        
        function updatePauseButton(segmentIndex, isPaused) {
            // 更新暫停/繼續按鈕的狀態
            const pauseBtn = document.getElementById(`pause-btn-${segmentIndex}`);
            if (pauseBtn) {
                pauseBtn.textContent = isPaused ? '▶ Resume' : '⏸ Pause';
                pauseBtn.style.opacity = currentSpeakingSegment === segmentIndex ? '1' : '0.5';
            }
        }
        
        function togglePauseSegment(segmentIndex) {
            // 暫停/繼續按鈕的點擊處理
            if (currentSpeakingSegment === segmentIndex) {
                speakSegment(segmentIndex);
            }
        }

        // YouTube Player
        function onYouTubeIframeAPIReady() {
            youtubeAPIReady = true;
            console.log('YouTube API Ready');
            // Only initialize player if a valid video ID is set
            if (videoId && videoId.length === 11) {
                player = new YT.Player('player', {
                    height: '100%',
                    width: '100%',
                    videoId: videoId,
                    playerVars: { rel: 0, modestbranding: 1 },
                    events: {
                        onReady: () => {
                            playerReady = true;
                            player.setPlaybackRate(currentPlaybackSpeed);
                            console.log('YouTube Player Ready');
                        },
                        onStateChange: (event) => {
                            updatePlayPauseButton();
                        }
                    }
                });
            }
        }
        
        function initializePlayer(id) {
            // Initialize player with a specific video ID
            if (!id || id.length !== 11) return;
            videoId = id;
            localStorage.setItem('videoId', id);
            
            // Wait for YouTube API to be ready
            if (!youtubeAPIReady || typeof YT === 'undefined' || typeof YT.Player === 'undefined') {
                console.log('等待 YouTube API 載入...');
                setTimeout(() => initializePlayer(id), 200);
                return;
            }
            
            if (!player) {
                player = new YT.Player('player', {
                    height: '100%',
                    width: '100%',
                    videoId: videoId,
                    playerVars: { rel: 0, modestbranding: 1 },
                    events: {
                        onReady: () => {
                            playerReady = true;
                            player.setPlaybackRate(currentPlaybackSpeed);
                            console.log('YouTube Player Ready');
                        },
                        onStateChange: (event) => {
                            updatePlayPauseButton();
                        }
                    }
                });
            } else if (playerReady) {
                player.loadVideoById(videoId);
            }
        }

        function jumpToTime(seconds) {
            if (!player || !playerReady || typeof seconds !== 'number') return;
            player.seekTo(seconds, true);
            player.playVideo();
        }

        function captureTime(idx) {
            if (!player || !playerReady || !transcriptData[idx]) return;
            const t = Math.floor(player.getCurrentTime());
            transcriptData[idx].t = t;
            localStorage.setItem('transcriptData', JSON.stringify(transcriptData));
            renderTranscript();
        }

        function setTimeByInput(idx) {
            if (!transcriptData[idx]) return;
            
            const minInput = document.getElementById(`min-input-${idx}`);
            const secInput = document.getElementById(`sec-input-${idx}`);
            
            const minutes = parseInt(minInput.value, 10) || 0;
            const seconds = parseInt(secInput.value, 10) || 0;
            
            if (minutes < 0 || seconds < 0 || seconds > 59) {
                alert('請輸入有效的時間（秒數必須 0-59）');
                return;
            }
            
            const totalSeconds = minutes * 60 + seconds;
            transcriptData[idx].t = totalSeconds;
            localStorage.setItem('transcriptData', JSON.stringify(transcriptData));
            renderTranscript();
            console.log(`✅ 時間戳記已設定: ${formatTime(totalSeconds)}`);
        }

        // Insert Transcript Modal Functions
        let currentInsertIndex = null;

        function openInsertModal(idx) {
            currentInsertIndex = idx;
            document.getElementById('insert-segment-index').textContent = idx + 1;
            document.getElementById('insert-input').value = '';
            document.getElementById('insert-modal').classList.remove('hidden');
            document.getElementById('insert-input').focus();
        }

        function closeInsertModal() {
            document.getElementById('insert-modal').classList.add('hidden');
            currentInsertIndex = null;
        }

        function copyInsertPrompt() {
            let promptText = '';
            
            // Add video URL if available
            if (videoId && videoId.length === 11) {
                promptText += `https://www.youtube.com/watch?v=${videoId}\n\n`;
            } else {
                promptText += '🔻\n\n';
            }
            
            promptText += `將以上影片從 ${formatTime(transcriptData[currentInsertIndex]?.t || 0)} 開始的演講內容，整理成英文和中文隨段落對照的逐字稿，並以以下格式嚴格依照 JSON Array 格式輸出結果：
{
    en: "When I found out my grandmother, my last living grandparent, was dying, my first thought was, \"I need to draw her hands.\" I'm a visual artist, a cartoonist for The New Yorker, and comics writer, so drawing is how I understand much of the world.",
    cn: "當我得知我的祖母——我最後一位在世的祖父母——即將離世時，我的第一個念頭是：「我需要畫下她的手。」我是一位視覺藝術家，也是《紐約客》的漫畫家和漫畫作者，所以繪畫是我理解這個世界的主要方式。"
},
{
    en: "For a long time, my cartoons had been impersonal. Commentary on the world around me, sure, but not really about me. The closest my personal life got to influencing my cartoons were cartoons I lifted from things my friends and family had said around me. It was only after my daughter Ellika was born that my personal life began to creep into my cartoons more.",
    cn: "很長一段時間以來，我的漫畫都是非個人化的。它們是對周遭世界的評論，沒錯，但並不真正關於我自己。我的個人生活對漫畫最接近的影響，頂多就是從朋友和家人的談話中取材。直到我女兒埃莉卡 (Ellika) 出生後，我的個人生活才開始更多地滲透進我的漫畫中。"
}`;
            
            navigator.clipboard.writeText(promptText).then(() => {
                const copyBtn = document.getElementById('copy-insert-prompt-btn');
                const originalHTML = copyBtn.innerHTML;
                copyBtn.innerHTML = '<span class="material-symbols-outlined">done</span>';
                copyBtn.classList.remove('bg-indigo-50', 'text-indigo-700');
                copyBtn.classList.add('bg-green-50', 'text-green-700');
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalHTML;
                    copyBtn.classList.remove('bg-green-50', 'text-green-700');
                    copyBtn.classList.add('bg-indigo-50', 'text-indigo-700');
                }, 2000);
                
                console.log('✅ Insert Prompt已複製到剪貼簿');
            }).catch(err => {
                console.error('複製失敗:', err);
                alert('複製失敗，請重試');
            });
        }

        function insertTranscriptFromIndex() {
            if (currentInsertIndex === null || currentInsertIndex === undefined) return;
            
            try {
                const input = document.getElementById('insert-input').value.trim();
                if (!input) {
                    alert('請輸入逐字稿資料');
                    return;
                }
                
                const newData = parseJSON(input);
                if (!Array.isArray(newData)) {
                    alert('格式錯誤：必須是陣列');
                    return;
                }
                
                if (newData.length === 0) {
                    alert('請至少輸入一段逐字稿');
                    return;
                }
                
                // Preserve segments before currentInsertIndex, replace everything from currentInsertIndex onwards
                const preservedSegments = transcriptData.slice(0, currentInsertIndex);
                transcriptData = [...preservedSegments, ...newData];
                
                localStorage.setItem('transcriptData', JSON.stringify(transcriptData));
                renderTranscript();
                closeInsertModal();
                
                alert(`✅ 已從段落 ${currentInsertIndex + 1} 插入 ${newData.length} 段逐字稿\n保留前 ${currentInsertIndex} 段，總共 ${transcriptData.length} 段`);
                console.log(`✅ 插入逐字稿: 保留 ${currentInsertIndex} 段，新增 ${newData.length} 段，總計 ${transcriptData.length} 段`);
            } catch (e) {
                alert('格式錯誤：' + e.message + '\n\n請確認 JSON 格式是否正確');
                console.error('格式錯誤: ', e);
            }
        }

        function editSegment(idx) {
            const seg = transcriptData[idx];
            if (!seg) return;
            
            // Store current editing index
            window.currentEditIndex = idx;
            
            // Fill in the modal
            document.getElementById('edit-en-input').value = seg.en || '';
            document.getElementById('edit-cn-input').value = seg.cn || '';
            document.getElementById('edit-time-input').value = typeof seg.t === 'number' ? seg.t : '';
            
            // Show modal
            document.getElementById('edit-modal').classList.remove('hidden');
            
            // Focus on English input
            setTimeout(() => {
                document.getElementById('edit-en-input').focus();
            }, 100);
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
            window.currentEditIndex = null;
        }

        function saveEdit() {
            const idx = window.currentEditIndex;
            if (idx === null || idx === undefined || !transcriptData[idx]) return;
            
            const enText = document.getElementById('edit-en-input').value.trim();
            const cnText = document.getElementById('edit-cn-input').value.trim();
            const timeInput = document.getElementById('edit-time-input').value.trim();
            
            if (enText) {
                transcriptData[idx].en = enText;
            }
            
            transcriptData[idx].cn = cnText;
            
            // Save time if provided
            if (timeInput !== '') {
                const timeSeconds = parseInt(timeInput, 10);
                if (!isNaN(timeSeconds) && timeSeconds >= 0) {
                    transcriptData[idx].t = timeSeconds;
                }
            }
            
            localStorage.setItem('transcriptData', JSON.stringify(transcriptData));
            renderTranscript();
            closeEditModal();
        }
        
        function previewEditTime() {
            const timeInput = document.getElementById('edit-time-input').value.trim();
            if (timeInput === '') {
                alert('請輸入時間（秒）');
                return;
            }
            
            const timeSeconds = parseInt(timeInput, 10);
            if (isNaN(timeSeconds) || timeSeconds < 0) {
                alert('請輸入有效的時間（0 秒以上）');
                return;
            }
            
            if (player && playerReady) {
                player.seekTo(timeSeconds, true);
                player.playVideo();
                console.log(`⏵ 跳轉到 ${formatTime(timeSeconds)}`);
            } else {
                alert('影片還未載入，請先設定影片');
            }
        }

        function formatTime(sec) {
            if (typeof sec !== 'number' || sec < 0) return '00:00';
            const m = Math.floor(sec / 60);
            const s = Math.floor(sec % 60);
            return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        // Interaction
        function showCard(e, id) {
            const vocab = vocabData.find(v => (v.id === id) || (v.word === id));
            if (!vocab) return;
            
            floatingCard.dataset.currentId = id;
            floatingCard.innerHTML = `
                <div class="p-4">
                    <div class="flex items-start justify-between mb-2">
                        <h3 class="text-xl font-bold flex-1">${vocab.word}</h3>
                        <button onclick="event.stopPropagation(); speakWord('${vocab.word}')" class="ml-2 p-2 rounded-lg bg-blue-50 hover:bg-blue-100 text-blue-600 transition" title="播放發音">
                            <span class="material-symbols-outlined text-lg">volume_up</span>
                        </button>
                    </div>
                    <div class="text-xs text-slate-500 mb-1">${vocab.pos || ''}</div>
                    ${vocab.ipa ? `<div class="text-xs text-blue-600 font-semibold mb-3">${vocab.ipa}</div>` : ''}
                    <p class="text-sm mb-3">${vocab.def}</p>
                    ${vocab.cn ? `<p class="text-xs text-blue-700 font-bold">${vocab.cn}</p>` : ''}
                </div>`;
            
            const rect = e.target.getBoundingClientRect();
            const cardWidth = 320;
            const cardHeight = 200; // 預估高度
            const padding = 10;
            
            // 計算最佳位置（避免超出螢幕）
            let left = rect.left;
            let top = rect.bottom + padding;
            
            // 水平方向調整
            if (left + cardWidth > window.innerWidth) {
                left = window.innerWidth - cardWidth - padding;
            }
            if (left < padding) {
                left = padding;
            }
            
            // 垂直方向調整（如果下方空間不足，顯示在上方）
            if (top + cardHeight > window.innerHeight) {
                top = rect.top - cardHeight - padding;
                if (top < padding) {
                    top = padding;
                }
            }
            
            floatingCard.style.left = left + 'px';
            floatingCard.style.top = top + 'px';
            floatingCard.classList.remove('hidden');
        }
        
        function toggleCard(e, id) {
            e.stopPropagation();
            e.preventDefault();
            
            // 如果已經顯示同一個字卡，則關閉
            if (!floatingCard.classList.contains('hidden') && floatingCard.dataset.currentId === id) {
                hideCard();
            } else {
                showCard(e, id);
            }
        }

        function hideCard() {
            floatingCard.classList.add('hidden');
            floatingCard.dataset.currentId = '';
        }
        
        // 點擊外部關閉字卡
        document.addEventListener('click', function(e) {
            // 延遲執行，讓 toggleCard 先完成
            setTimeout(() => {
                if (!floatingCard.classList.contains('hidden') && 
                    !floatingCard.contains(e.target) && 
                    !e.target.closest('.vocab-word') && 
                    !e.target.closest('.vocab-word-custom')) {
                    hideCard();
                }
            }, 100);
        });

        function toggleTranslations() {
            translationsVisible = !translationsVisible;
            const toggleBtnText = document.getElementById('toggle-btn-text');
            const cnToggleText = document.getElementById('cn-toggle-text');
            
            if (toggleBtnText) {
                toggleBtnText.innerText = translationsVisible ? "Hide CN" : "Show CN";
            }
            if (cnToggleText) {
                cnToggleText.innerText = translationsVisible ? "隱藏" : "中文";
            }
            
            applyTranslationState();
        }

        // Quiz Logic
        function openQuiz() {
            const modal = document.getElementById('quiz-modal');
            modal.classList.remove('hidden');
            
            // 檢查是否為雙語格式
            const isBilingual = typeof quizData === 'object' && quizData !== null && !Array.isArray(quizData) && 'english' in quizData && 'chinese' in quizData;
            
            // 顯示或隱藏語言選擇器
            const languageSelector = document.getElementById('quiz-language-selector');
            if (isBilingual) {
                languageSelector.classList.remove('hidden');
                updateQuizLanguageSelector();
            } else {
                languageSelector.classList.add('hidden');
            }
            
            renderQuizContent();
        }

        function renderQuizContent() {
            const content = document.getElementById('quiz-content');
            const footer = document.getElementById('quiz-footer');

            // 檢查是否為雙語格式或傳統格式
            let questionsToDisplay = [];
            let isBilingual = false;
            
            if (typeof quizData === 'object' && quizData !== null && !Array.isArray(quizData) && 'english' in quizData && 'chinese' in quizData) {
                // 雙語格式
                isBilingual = true;
                questionsToDisplay = quizLanguage === 'english' ? quizData.english : quizData.chinese;
            } else if (Array.isArray(quizData)) {
                // 傳統格式
                questionsToDisplay = quizData;
            }

            if (!Array.isArray(questionsToDisplay) || questionsToDisplay.length === 0) {
                content.innerHTML = `
                    <div class="p-6 rounded-xl border border-slate-200 bg-slate-50 text-slate-700">
                        尚未匯入 Quiz 題庫，請先用上方的 Quiz Data 按鈕貼上題庫。
                    </div>
                `;
                footer.innerHTML = `<button onclick="closeQuiz()" class="bg-slate-800 text-white px-6 py-2 rounded-lg font-bold hover:bg-slate-900 transition">Close</button>`;
                return;
            }

            footer.innerHTML = `<button onclick="submitQuiz()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 shadow-md transition">Submit Answers</button>`;

            content.innerHTML = questionsToDisplay.map((q, i) => `
                <div class="mb-6 p-5 rounded-xl border border-gray-100 hover:border-blue-100 transition-colors" id="q-block-${i}">
                    <p class="font-bold text-lg mb-4 text-slate-800 flex gap-2">
                        <span class="bg-blue-100 text-blue-700 w-7 h-7 flex items-center justify-center rounded-full text-sm shrink-0">${i + 1}</span>
                        ${q.q}
                    </p>
                    <div class="space-y-3 pl-9">
                        ${(q.options || []).map((opt, optIdx) => `
                            <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-300 transition group">
                                <input type="radio" name="q${i}" value="${optIdx}" class="mr-3 w-4 h-4 text-blue-600 focus:ring-blue-500">
                                <span class="text-slate-600 group-hover:text-slate-900">${opt}</span>
                            </label>
                        `).join('')}
                    </div>
                    <div class="feedback hidden mt-4 ml-9 p-3 rounded-lg text-sm font-bold flex items-center gap-2"></div>
                </div>
            `).join('');
        }

        function closeQuiz() {
            document.getElementById('quiz-modal').classList.add('hidden');
        }

        function submitQuiz() {
            let score = 0;
            let allAnswered = true;

            // 決定使用哪份題庫
            let questionsToScore = [];
            if (typeof quizData === 'object' && quizData !== null && !Array.isArray(quizData) && 'english' in quizData && 'chinese' in quizData) {
                // 雙語格式 - 根據選擇的語言取用對應版本
                questionsToScore = quizLanguage === 'english' ? quizData.english : quizData.chinese;
            } else if (Array.isArray(quizData)) {
                // 傳統格式
                questionsToScore = quizData;
            }

            questionsToScore.forEach((q, i) => {
                const selected = document.querySelector(`input[name="q${i}"]:checked`);
                const block = document.getElementById(`q-block-${i}`);
                const feedback = block ? block.querySelector('.feedback') : null;

                if (!block || !feedback) return;

                block.classList.remove('bg-green-50', 'border-green-200', 'bg-red-50', 'border-red-200');
                feedback.className = 'feedback hidden mt-4 ml-9 p-3 rounded-lg text-sm font-bold flex items-center gap-2';

                if (selected) {
                    feedback.classList.remove('hidden');
                    if (parseInt(selected.value, 10) === q.correct) {
                        score++;
                        feedback.innerHTML = `<span class="material-symbols-outlined">check_circle</span> Correct!`;
                        feedback.classList.add('bg-green-100', 'text-green-700');
                        block.classList.add('bg-green-50/50', 'border-green-200');
                    } else {
                        feedback.innerHTML = `<span class="material-symbols-outlined">cancel</span> Incorrect. The correct answer is: <span class="italic">${q.options[q.correct]}</span>`;
                        feedback.classList.add('bg-red-100', 'text-red-700');
                        block.classList.add('bg-red-50/50', 'border-red-200');
                    }
                } else {
                    allAnswered = false;
                }
            });

            const footer = document.getElementById('quiz-footer');
            if (allAnswered || confirm("You haven't answered all questions. Submit anyway?")) {
                let message = '';
                let colorClass = '';

                if (score === questionsToScore.length) {
                    message = 'Perfect Score! 🎉';
                    colorClass = 'text-green-600';
                } else if (score > questionsToScore.length / 2) {
                    message = 'Great Job! 👍';
                    colorClass = 'text-blue-600';
                } else {
                    message = 'Keep Practicing! 💪';
                    colorClass = 'text-orange-500';
                }

                footer.innerHTML = `
                    <div class="flex items-center gap-4 w-full justify-between">
                        <div>
                            <p class="text-sm text-gray-500 uppercase tracking-wider font-bold">Your Score</p>
                            <p class="text-2xl font-bold ${colorClass}">${score} / ${questionsToScore.length} - ${message}</p>
                        </div>
                        <button onclick="closeQuiz()" class="bg-slate-800 text-white px-6 py-2 rounded-lg font-bold hover:bg-slate-900 transition">Close</button>
                    </div>`;
            }
        }

        function applyTranslationState() {
            document.querySelectorAll('.cn-text').forEach(el => {
                if (translationsVisible) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });
        }

        function scrollToVocab(id) {
            const span = document.querySelector(`.vocab-word[data-id="${id}"]`);
            if (span) {
                span.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function increaseFontSize() {
            if (currentFontSize < 32) {
                currentFontSize += 2;
                applyFontSize();
            }
        }

        function decreaseFontSize() {
            if (currentFontSize > 12) {
                currentFontSize -= 2;
                applyFontSize();
            }
        }

        function applyFontSize() {
            const transcriptContent = document.getElementById('transcript-content');
            if (transcriptContent) {
                transcriptContent.style.fontSize = currentFontSize + 'px';
            }
        }

        function increasePlaybackSpeed() {
            if (!player || !playerReady) return;
            const speeds = [0.25, 0.5, 0.75, 1.0, 1.25, 1.5, 1.75, 2.0];
            const currentIndex = speeds.indexOf(currentPlaybackSpeed);
            if (currentIndex < speeds.length - 1) {
                currentPlaybackSpeed = speeds[currentIndex + 1];
                player.setPlaybackRate(currentPlaybackSpeed);
                updateSpeedDisplay();
            }
        }

        function decreasePlaybackSpeed() {
            if (!player || !playerReady) return;
            const speeds = [0.25, 0.5, 0.75, 1.0, 1.25, 1.5, 1.75, 2.0];
            const currentIndex = speeds.indexOf(currentPlaybackSpeed);
            if (currentIndex > 0) {
                currentPlaybackSpeed = speeds[currentIndex - 1];
                player.setPlaybackRate(currentPlaybackSpeed);
                updateSpeedDisplay();
            }
        }

        function updateSpeedDisplay() {
            const display = document.getElementById('speed-display');
            if (display) {
                display.textContent = currentPlaybackSpeed.toFixed(2) + 'x';
            }
        }

        function togglePlayPause() {
            if (!player || !playerReady) return;
            
            const state = player.getPlayerState();
            const playIcon = document.getElementById('play-icon');
            const playText = document.getElementById('play-text');
            
            // YT.PlayerState: UNSTARTED (-1), ENDED (0), PLAYING (1), PAUSED (2), BUFFERING (3), CUED (5)
            if (state === 1) { // Playing
                player.pauseVideo();
                playIcon.textContent = 'play_arrow';
                playText.textContent = '播放';
            } else { // Paused or other states
                player.playVideo();
                playIcon.textContent = 'pause';
                playText.textContent = '暫停';
            }
        }

        function updatePlayPauseButton() {
            if (!player || !playerReady) return;
            const state = player.getPlayerState();
            const playIcon = document.getElementById('play-icon');
            const playText = document.getElementById('play-text');
            
            if (state === 1) { // Playing
                playIcon.textContent = 'pause';
                playText.textContent = '暫停';
            } else {
                playIcon.textContent = 'play_arrow';
                playText.textContent = '播放';
            }
        }

        function resetSettings() {
            currentFontSize = 18;
            applyFontSize();
            
            if (player && playerReady) {
                currentPlaybackSpeed = 1.0;
                player.setPlaybackRate(currentPlaybackSpeed);
                updateSpeedDisplay();
            }
            
            translationsVisible = false;
            const toggleBtnText = document.getElementById('toggle-btn-text');
            const cnToggleText = document.getElementById('cn-toggle-text');
            if (toggleBtnText) toggleBtnText.innerText = 'Show CN';
            if (cnToggleText) cnToggleText.innerText = '中文';
            applyTranslationState();
        }

        function changeVideoUrl() {
            const newUrl = prompt('貼上 YouTube 網址或影片 ID:', videoId);
            if (!newUrl || newUrl.trim() === '') return;
            
            try {
                let id = newUrl.trim();
                
                // 提取影片 ID
                let m = id.match(/[?&]v=([^&]+)/);
                if (m) id = m[1];
                
                m = id.match(/youtu\.be\/([^?]+)/);
                if (m) id = m[1];
                
                id = id.split('&')[0].split('?')[0];
                
                if (id.length !== 11) throw new Error("無效的影片 ID");
                
                videoId = id;
                if (player && playerReady) {
                    player.loadVideoById(videoId);
                    console.log(`✅ 影片已更換: ${videoId}`);
                }
            } catch (e) {
                console.error("錯誤: " + e.message);
            }
        }

        // Export Function
        function downloadHTML() {
            const clone = document.documentElement.cloneNode(true);
            
            // Replace entire navigation bar with simplified Export-only version
            const nav = clone.querySelector('nav');
            if (nav) {
                const linksListHtml = headerLinks.map(link => 
                    `<a href="${link.url}" target="_blank" rel="noopener" class="block px-3 py-2 text-xs text-blue-600 hover:bg-blue-50 rounded">${link.name}</a>`
                ).join('');
                
                nav.innerHTML = `
                    <div class="max-w-7xl mx-auto px-4 sm:px-6">
                        <div class="flex justify-between h-16 items-center">
                            <div class="flex items-center gap-3">
                                <div class="relative">
                                    <button id="header-links-trigger-export" class="flex items-center gap-3 text-left rounded-lg px-2 py-1 -ml-2 hover:bg-slate-50 transition">
                                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
                                            <span class="material-symbols-outlined text-white text-xl">school</span>
                                        </div>
                                        <div class="flex flex-col">
                                            <div class="font-bold text-lg text-slate-900">StudyEngine</div>
                                            <div class="text-xs text-slate-500 hidden sm:block">英語學習平台</div>
                                        </div>
                                    </button>
                                    <div id="header-links-menu-export" class="hidden absolute left-0 mt-2 w-64 bg-white border border-slate-200 rounded-xl shadow-lg z-50 p-2">
                                        <div class="text-xs font-semibold text-slate-600 px-2 py-1 mb-1">固定連結</div>
                                        ${linksListHtml || '<div class="px-2 py-1 text-xs text-slate-400">無連結</div>'}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="relative">
                                <button onclick="toggleExportMenu()" class="px-3 py-2 rounded-lg border border-purple-200 bg-purple-50 hover:bg-purple-100 text-purple-700 transition text-sm font-medium flex items-center gap-1.5">
                                    <span class="material-symbols-outlined text-lg">bookmark</span>
                                    <span class="hidden sm:inline">Export Words (</span><span class="sm:hidden">(</span><span id="selected-count">${selectedWords.length}</span><span>)</span>
                                </button>
                                <div id="export-menu" class="hidden absolute top-full right-0 mt-2 bg-white border border-slate-200 rounded-xl shadow-lg z-50 min-w-max overflow-hidden">
                                    <button onclick="copyExportPrompt()" class="w-full px-4 py-2.5 text-left hover:bg-blue-50 border-b border-slate-100 flex items-center gap-2 text-sm" title="複製生成AI指令的Prompt">
                                        <span class="material-symbols-outlined text-sm text-blue-600">content_copy</span> <span>複製 Prompt</span>
                                    </button>
                                    <button onclick="exportSelectedWords()" class="w-full px-4 py-2.5 text-left hover:bg-blue-50 flex items-center gap-2 text-sm" title="下載選中的生字">
                                        <span class="material-symbols-outlined text-sm text-blue-600">download</span> <span>下載文字檔</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Remove all Five Server and third-party injected code
            const scriptsToRemove = clone.querySelectorAll('script[data-id="five-server"], script[id="www-widgetapi-script"]');
            scriptsToRemove.forEach(s => s.remove());
            
            // Remove all injected styles (Five Server, Tailwind compiled, third-party)
            const stylesToRemove = clone.querySelectorAll('style[id*="five"], style[class*="five"], style:not([type])');
            stylesToRemove.forEach(s => {
                const content = s.textContent || '';
                if (content.includes('five-server') || 
                    content.includes('fiveserver') || 
                    content.includes('keyword-info') ||
                    content.includes('tippy-') ||
                    content.includes('ubersuggest') ||
                    content.includes('bl-info') ||
                    content.includes('kw-info') ||
                    content.includes('statistics-graph') ||
                    content.includes('ue-sidebar') ||
                    content.includes('tw-border-spacing') ||
                    content.includes('tailwindcss v3.4')) {
                    s.remove();
                }
            });
            
            // Remove Ubersuggest/extension divs
            const extensionDivs = clone.querySelectorAll('.ue-sidebar-container, [class*="ubersuggest"]');
            extensionDivs.forEach(div => div.remove());

            let html = clone.outerHTML;

            // Fix toggleExportMenu function for exported file (use 'export-menu' instead of type parameter)
            html = html.replace(
                /function toggleExportMenu\(type = 'desktop'\) \{\s*const menuId = type === 'mobile' \? 'export-menu-mobile' : 'export-menu-desktop';/,
                `function toggleExportMenu(type = 'desktop') {
            const menuId = 'export-menu';`
            );
            
            // Add toggleMobileMenu function if not present
            if (!html.includes('function toggleMobileMenu()')) {
                const insertPoint = html.indexOf('function toggleExportMenu');
                if (insertPoint !== -1) {
                    html = html.slice(0, insertPoint) + 
                           `function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const btn = document.getElementById('hamburger-btn');
            if (!menu || !btn) return;
            menu.classList.toggle('hidden');
            btn.classList.toggle('active');
        }

        ` + 
                           html.slice(insertPoint);
                }
            }

            // Remove Insert button from exported file
            html = html.replace(
                /<button[^>]*onclick="openInsertModal\([^)]*\)"[^>]*>[\s\S]*?<\/button>\s*/g,
                ''
            );

            // Inject data (keep videoId empty for exported files)
            html = html.replace(
                /let transcriptData = (?:\[.*?\]|JSON\.parse\(localStorage\.getItem\('transcriptData'\) \|\| '\[\]'\));/s,
                `let transcriptData = ${JSON.stringify(transcriptData)};`
            );
            html = html.replace(
                /let vocabData = (?:\[.*?\]|JSON\.parse\(localStorage\.getItem\('vocabData'\) \|\| '\[\]'\));/s,
                `let vocabData = ${JSON.stringify(vocabData)};`
            );
            html = html.replace(
                /let quizData = (?:\[.*?\]|\{.*?\}|JSON\.parse\(localStorage\.getItem\('quizData'\) \|\| '\[\]'\));/s,
                `let quizData = ${JSON.stringify(quizData)};`
            );
            html = html.replace(
                /let selectedWords = (?:\[.*?\]|JSON\.parse\(localStorage\.getItem\('selectedWords'\) \|\| '\[\]'\));/s,
                `let selectedWords = ${JSON.stringify(selectedWords)};`
            );
            html = html.replace(
                /let videoId = (?:localStorage\.getItem\('videoId'\) \|\| ''|'[^']*');/,
                `let videoId = localStorage.getItem('videoId') || '';`
            );

            // 確保 player 是空的 div，不要包含 iframe
            html = html.replace(
                /<iframe[^>]*id="player"[^>]*>[\s\S]*?<\/iframe>/,
                '<div id="player" class="absolute inset-0"></div>'
            );
            html = html.replace(
                /<div id="player"[^>]*>[\s\S]*?<\/div>/,
                '<div id="player" class="absolute inset-0"></div>'
            );

            // Remove Capture buttons from exported file
            html = html.replace(
                /<button[^>]*onclick="captureTime\([^)]+\)"[^>]*>[\s\S]*?Capture[\s\S]*?<\/button>/g,
                ''
            );
            
            // Remove captureTime function from exported file
            html = html.replace(
                /function captureTime\([^)]*\) \{[\s\S]*?\n        \}/,
                ''
            );
            
            // Remove setTimeByInput function from exported file
            html = html.replace(
                /function setTimeByInput\([^)]*\) \{[\s\S]*?\n        \}/,
                ''
            );
            
            // Add CSS to hide time input fields in exported file
            html = html.replace(
                /(<\/style>)/,
                `        
        /* Hide time input fields */
        .flex.items-center.gap-0.bg-blue-50 {
            display: none !important;
        }
$1`
            );
            
            // Update video section hint text
            html = html.replace(
                /點擊時間標籤跳轉，按 Capture 設定當前播放時間/,
                '點擊時間標籤跳轉到指定時間'
            );

            // Inject header links toggle script for exported file
            const headerLinksScript = `
        const headerLinksTriggerExport = document.getElementById('header-links-trigger-export');
        const headerLinksMenuExport = document.getElementById('header-links-menu-export');
        
        if (headerLinksTriggerExport && headerLinksMenuExport) {
            headerLinksTriggerExport.addEventListener('click', (e) => {
                e.stopPropagation();
                headerLinksMenuExport.classList.toggle('hidden');
            });
            
            document.addEventListener('click', (e) => {
                if (!headerLinksMenuExport.classList.contains('hidden')) {
                    const withinMenu = headerLinksMenuExport.contains(e.target);
                    const withinTrigger = headerLinksTriggerExport.contains(e.target);
                    if (!withinMenu && !withinTrigger) {
                        headerLinksMenuExport.classList.add('hidden');
                    }
                }
            });
        }
            `;
            
            html = html.replace(
                /(<\/body>)/,
                `<script>${headerLinksScript}<\/script>$1`
            );

            // Download
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'study_guide.html';
            a.click();
            URL.revokeObjectURL(url);

            console.log(`✅ 匯出成功！\n逐字稿: ${transcriptData.length} 段\n單字: ${vocabData.length} 個\n影片: 需透過「更換影片」按鈕設定`);
        }

        // Load YouTube API
        const tag = document.createElement('script');
        tag.src = 'https://www.youtube.com/iframe_api';
        document.head.appendChild(tag);

        // Global YouTube Ready handler
        window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;

        // Initialize if data exists
        if (transcriptData.length > 0 || vocabData.length > 0) {
            renderTranscript();
            renderVocab();
        }
        
        // Update transcript title if CEFR level is set
        if (cefrLevel) {
            const transcriptTitle = document.getElementById('transcript-title');
            if (transcriptTitle) {
                transcriptTitle.textContent = `摘要（${cefrLevel}）`;
            }
            // Activate summary mode if CEFR level is persisted
            document.body.classList.add('summary-mode');
        }
        
        // Update selected word count
        updateSelectedCount();
        
        // Text Selection Handler
        document.addEventListener('mouseup', handleTextSelection);
        
        function handleTextSelection(e) {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            
            if (!selectedText || selectedText.length === 0) {
                hideSelectionPopup();
                return;
            }
            
            // Check if selection is within transcript
            const container = document.getElementById('transcript-content');
            if (!container || !container.contains(selection.anchorNode)) {
                hideSelectionPopup();
                return;
            }
            
            // Show popup near cursor
            const popup = document.getElementById('selection-popup');
            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            
            popup.style.left = (rect.left + rect.width / 2 - 60) + 'px';
            popup.style.top = (rect.top - 45) + 'px';
            popup.classList.remove('hidden');
            
            popup.onclick = () => addSelectedWord(selectedText);
        }
        
        function hideSelectionPopup() {
            const popup = document.getElementById('selection-popup');
            if (popup) popup.classList.add('hidden');
        }
        
        function addSelectedWord(word) {
            word = word.trim();
            if (!word || selectedWords.includes(word)) {
                hideSelectionPopup();
                window.getSelection().removeAllRanges();
                return;
            }
            
            selectedWords.push(word);
            localStorage.setItem('selectedWords', JSON.stringify(selectedWords));
            updateSelectedCount();
            highlightSelectedWords();
            hideSelectionPopup();
            window.getSelection().removeAllRanges();
            
            console.log(`✅ 已加入生字: ${word}`);
        }
        
        function removeSelectedWord(word) {
            word = word.trim();
            const index = selectedWords.indexOf(word);
            if (index > -1) {
                selectedWords.splice(index, 1);
                localStorage.setItem('selectedWords', JSON.stringify(selectedWords));
                updateSelectedCount();
                highlightSelectedWords();
                console.log(`❌ 已取消選取: ${word}`);
            }
        }
        
        function updateSelectedCount() {
            const countEl = document.getElementById('selected-count');
            const countElMobile = document.getElementById('selected-count-mobile');
            if (countEl) countEl.textContent = selectedWords.length;
            if (countElMobile) countElMobile.textContent = selectedWords.length;
        }
        
        function highlightSelectedWords() {
            const container = document.getElementById('transcript-content');
            if (!container) return;
            
            // Remove existing highlights
            container.querySelectorAll('.selected-word').forEach(el => {
                el.outerHTML = el.textContent;
            });
            
            // Re-render to apply new highlights
            renderTranscript();
        }
        
        function toggleExportMenu(type = 'desktop') {
            const menuId = type === 'mobile' ? 'export-menu-mobile' : 'export-menu-desktop';
            const menu = document.getElementById(menuId);
            if (!menu) return;
            
            menu.classList.toggle('hidden');
            
            // 點擊外部時關閉選單
            if (!menu.classList.contains('hidden')) {
                document.addEventListener('click', (e) => {
                    if (!e.target.closest(`#${menuId}`) && !e.target.closest('button[onclick*="toggleExportMenu"]')) {
                        menu.classList.add('hidden');
                    }
                }, { once: true });
            }
        }
        
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const btn = document.getElementById('hamburger-btn');
            
            menu.classList.toggle('hidden');
            btn.classList.toggle('active');
            
            // 點擊外部時關閉選單
            if (!menu.classList.contains('hidden')) {
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#mobile-menu') && !e.target.closest('#hamburger-btn')) {
                        menu.classList.add('hidden');
                        btn.classList.remove('active');
                    }
                }, { once: true });
            }
        }

        function generateExportPrompt() {
            if (selectedWords.length === 0) {
                return '';
            }
            
            let prompt = selectedWords.join('\n');
            prompt += '\n\n將以上英文單字嚴格依照以下 JSON Array 格式輸出結果：\n\n';
            prompt += '1.  **id**: 單字的全小寫形式。\n';
            prompt += '2.  **word**: 單字的首字母大寫。\n';
            prompt += '3.  **ipa**: 該單字的 IPA 音標。\n';
            prompt += '4.  **pos**: 詞性 (如 noun, verb, adjective)。\n';
            prompt += '5.  **def**: 簡潔的英文定義。\n';
            prompt += '6.  **cn**: 繁體中文解釋 (若有特定語境請一併標註)。\n';
            prompt += '7.  **image**: 請輸出格式為 `https://source.unsplash.com/featured/?{單字}` 的連結，將 `{單字}` 替換為該單字的英文內容，以便自動抓取相關圖片。\n\n';
            prompt += '範例格式：\n\n';
            prompt += '[\n';
            prompt += '    {\n';
            prompt += '        "id": "pareidolia",\n';
            prompt += '        "word": "Pareidolia",\n';
            prompt += '        "ipa": "/ˌpær.ɪˈdoʊ.li.ə/",\n';
            prompt += '        "pos": "noun",\n';
            prompt += '        "def": "The psychological phenomenon of seeing recognizable shapes, especially faces, in random or vague stimuli.",\n';
            prompt += '        "cn": "幻想性錯覺 (尤指將模糊圖像看作人臉)",\n';
            prompt += '        "image": "https://source.unsplash.com/featured/?pareidolia"\n';
            prompt += '    }\n';
            prompt += ']\n';
            
            return prompt;
        }

        function copyExportPrompt() {
            if (selectedWords.length === 0) {
                alert('尚未選取任何生字');
                return;
            }
            
            const prompt = generateExportPrompt();
            navigator.clipboard.writeText(prompt).then(() => {
                document.getElementById('export-menu').classList.add('hidden');
                console.log(`✅ Export Prompt 已複製 (${selectedWords.length} 個生字)`);
            }).catch(() => {
                alert('複製失敗，請重試');
            });
        }

        function exportSelectedWords() {
            if (selectedWords.length === 0) {
                alert('尚未選取任何生字');
                return;
            }
            
            const text = selectedWords.map((word, i) => `${i + 1}. ${word}`).join('\n');
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'selected_words.txt';
            a.click();
            URL.revokeObjectURL(url);
            
            console.log(`✅ 已匯出 ${selectedWords.length} 個生字`);
        }
    </script>
</body>
</html>
