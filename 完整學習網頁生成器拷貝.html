<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>完整學習網頁生成器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,300&family=Inter:wght@400;500;600;700&family=Material+Symbols+Outlined" rel="stylesheet">
    <style>
        .vocab-word { 
            border-bottom: 2px solid #93c5fd; 
            cursor: pointer; 
            color: #1d4ed8; 
            font-weight: 700; 
            transition: all 0.2s; 
        }
        .vocab-word:hover { 
            background-color: #dbeafe; 
        }
        #floating-card { 
            transition: opacity 0.2s, transform 0.2s; 
            pointer-events: none; 
            z-index: 9999; 
        }
        .modal { transition: opacity 0.2s ease-in-out; }
        .modal.hidden { opacity: 0; pointer-events: none; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <nav class="bg-white border-b border-gray-200 sticky top-0 z-40 shadow-sm">
        <div class="max-w-7xl mx-auto px-6">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined text-blue-600">school</span>
                    <span class="font-bold text-xl">Study<span class="text-blue-600">Engine</span></span>
                </div>
                
                <div id="action-buttons" class="flex items-center gap-3">
                    <button onclick="openModal('video')" class="px-3 py-1.5 rounded-lg border hover:bg-red-50 hover:text-red-600">
                        <span class="material-symbols-outlined text-xl">play_circle</span> Video
                    </button>
                    <button onclick="openModal('transcript')" class="px-3 py-1.5 rounded-lg border hover:bg-green-50 hover:text-green-600">
                        <span class="material-symbols-outlined text-xl">description</span> Text
                    </button>
                    <button onclick="openModal('vocab')" class="px-3 py-1.5 rounded-lg border hover:bg-amber-50 hover:text-amber-600">
                        <span class="material-symbols-outlined text-xl">style</span> Vocab
                    </button>
                    <button onclick="downloadHTML()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-700">
                        <span class="material-symbols-outlined text-lg">save_alt</span> Save
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-6 py-8">
        
        <!-- Video Section (Will be included in export) -->
        <section id="video-section" class="mb-8 bg-white rounded-2xl p-6 shadow-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <span class="material-symbols-outlined text-red-600">play_circle</span>
                    YouTube Player
                </h3>
                <button onclick="openModal('video')" class="px-3 py-1.5 rounded-lg border border-blue-300 bg-blue-50 text-blue-700 hover:bg-blue-100 text-sm font-semibold">
                    <span class="material-symbols-outlined text-base">edit_note</span> 更換影片
                </button>
            </div>
            <div class="relative w-full bg-black rounded-xl overflow-hidden" style="padding-top: 56.25%;">
                <div id="player" class="absolute inset-0"></div>
            </div>
            <p class="text-sm text-slate-600 mt-3">
                點擊時間標籤跳轉，按 Capture 設定當前播放時間
            </p>
        </section>

        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Transcript -->
            <main class="lg:w-2/3 bg-white p-8 rounded-2xl shadow-lg">
                <div class="flex justify-between mb-6 border-b pb-4">
                    <h2 class="text-2xl font-bold">Transcript</h2>
                    <button onclick="toggleTranslations()" class="text-blue-600 font-bold hover:bg-blue-50 px-3 py-1 rounded">
                        <span class="material-symbols-outlined">translate</span> <span id="toggle-btn-text">Show CN</span>
                    </button>
                </div>
                
                <div id="transcript-content" class="space-y-8 text-lg leading-loose">
                    <p class="text-center text-slate-400 py-12">匯入逐字稿後顯示於此...</p>
                </div>
            </main>

            <!-- Vocab Sidebar -->
            <aside class="lg:w-1/3">
                <div class="sticky top-24 bg-white rounded-2xl shadow-lg p-5">
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-amber-500">verified</span> Vocabulary
                        <span class="text-xs bg-slate-200 px-2 py-0.5 rounded" id="vocab-count">0</span>
                    </h3>
                    <ul id="vocab-list" class="divide-y max-h-[70vh] overflow-y-auto">
                        <li class="text-sm text-slate-400 italic text-center py-8">尚未匯入單字</li>
                    </ul>
                </div>
            </aside>
        </div>
    </div>

    <!-- Bottom Control Bar (Will be kept in export) -->
    <div id="bottom-controls" class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg z-40 px-3 py-2">
        <div class="flex flex-wrap justify-center gap-2">
            <button id="play-pause-btn" onclick="togglePlayPause()" class="flex items-center gap-1 px-4 py-2 rounded-lg bg-red-600 text-white font-semibold shadow-md active:scale-95 transition-transform">
                <span class="material-symbols-outlined text-lg" id="play-icon">play_arrow</span>
                <span id="play-text" class="text-sm">播放</span>
            </button>
            
            <button onclick="decreaseFontSize()" class="px-3 py-2 rounded-lg border border-slate-300 bg-slate-50 text-xs active:bg-slate-200">
                <span class="material-symbols-outlined text-sm">text_decrease</span>
            </button>
            <button onclick="increaseFontSize()" class="px-3 py-2 rounded-lg border border-slate-300 bg-slate-50 text-xs active:bg-slate-200">
                <span class="material-symbols-outlined text-sm">text_increase</span>
            </button>
            
            <button onclick="decreasePlaybackSpeed()" class="px-3 py-2 rounded-lg border border-slate-300 bg-slate-50 text-sm active:bg-slate-200">
                <span class="material-symbols-outlined text-base">remove</span>
            </button>
            <div class="flex items-center px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm font-bold min-w-[60px] justify-center">
                <span id="speed-display">1.0x</span>
            </div>
            <button onclick="increasePlaybackSpeed()" class="px-3 py-2 rounded-lg border border-slate-300 bg-slate-50 text-sm active:bg-slate-200">
                <span class="material-symbols-outlined text-base">add</span>
            </button>
            
            <button onclick="toggleTranslations()" class="px-3 py-2 rounded-lg border border-blue-300 bg-blue-50 text-blue-700 text-xs font-semibold active:bg-blue-100">
                <span class="material-symbols-outlined text-sm">translate</span> <span id="cn-toggle-text">中文</span>
            </button>
            <button onclick="resetSettings()" class="px-3 py-2 rounded-lg border border-slate-300 bg-slate-50 text-xs active:bg-slate-200">
                <span class="material-symbols-outlined text-sm">restart_alt</span>
            </button>
        </div>
    </div>

    <!-- Floating Card -->
    <div id="floating-card" class="fixed hidden bg-white rounded-xl shadow-2xl w-80 border z-50"></div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="modal hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl w-full max-w-4xl flex flex-col h-[85vh]">
            <div class="p-5 border-b flex justify-between items-center">
                <h3 class="font-bold text-lg">編輯逐字稿段落</h3>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-700 rounded p-1">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            
            <div class="p-6 flex-1 flex flex-col gap-4 overflow-y-auto">
                <div class="flex-1 flex flex-col">
                    <label class="font-semibold mb-2 text-sm text-slate-700">英文內容</label>
                    <textarea id="edit-en-input" class="flex-1 border-2 border-slate-300 rounded-lg p-4 font-sans text-base resize-none focus:border-blue-500 focus:outline-none min-h-[200px]" placeholder="輸入英文內容..."></textarea>
                </div>
                
                <div class="flex-1 flex flex-col">
                    <label class="font-semibold mb-2 text-sm text-slate-700">中文翻譯</label>
                    <textarea id="edit-cn-input" class="flex-1 border-2 border-slate-300 rounded-lg p-4 font-sans text-base resize-none focus:border-blue-500 focus:outline-none min-h-[200px]" placeholder="輸入中文翻譯（可選）..."></textarea>
                </div>
            </div>
            
            <div class="p-4 border-t flex justify-end gap-3">
                <button onclick="closeEditModal()" class="px-6 py-2.5 rounded-lg border border-slate-300 hover:bg-slate-50 font-medium">取消</button>
                <button onclick="saveEdit()" class="bg-blue-600 text-white px-6 py-2.5 rounded-lg font-bold hover:bg-blue-700">儲存</button>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="import-modal" class="modal hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl w-full max-w-3xl flex flex-col h-[80vh]">
            <div class="p-5 border-b flex justify-between items-center">
                <h3 class="font-bold text-lg" id="modal-title">Import</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-700 rounded p-1">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            
            <div class="p-4 flex-1 flex flex-col gap-3">
                <div id="modal-hint" class="bg-blue-50 text-blue-800 p-3 rounded text-xs"></div>
                <textarea id="import-input" class="flex-1 border rounded p-4 font-mono text-xs resize-none"></textarea>
            </div>
            
            <div class="p-4 border-t flex justify-end gap-3">
                <button onclick="closeModal()" class="px-4 py-2 rounded hover:bg-gray-100">Cancel</button>
                <button id="import-action-btn" class="bg-blue-600 text-white px-6 py-2 rounded font-bold">Load</button>
            </div>
        </div>
    </div>

    <script>
        // Global State - Load from localStorage
        let transcriptData = JSON.parse(localStorage.getItem('transcriptData') || '[]');
        let vocabData = JSON.parse(localStorage.getItem('vocabData') || '[]');
        let videoId = localStorage.getItem('videoId') || '';
        let translationsVisible = false;
        let player;
        let playerReady = false;
        let youtubeAPIReady = false;
        let currentFontSize = 18; // base font size in px
        let currentPlaybackSpeed = 1.0;

        const modal = document.getElementById('import-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalHint = document.getElementById('modal-hint');
        const inputArea = document.getElementById('import-input');
        const actionBtn = document.getElementById('import-action-btn');
        const floatingCard = document.getElementById('floating-card');

        // Modal Functions
        function openModal(mode) {
            modal.classList.remove('hidden');
            inputArea.value = '';
            inputArea.focus();
            
            if (mode === 'video') {
                modalTitle.innerText = "設定 YouTube 影片";
                modalHint.innerText = '貼上 YouTube 網址或影片 ID';
                inputArea.placeholder = 'https://www.youtube.com/watch?v=...';
                actionBtn.onclick = parseVideoUrl;
            } else if (mode === 'transcript') {
                modalTitle.innerText = "匯入逐字稿";
                modalHint.innerText = '格式：[{ "en": "...", "cn": "...", "t": 0 }, ...]';
                inputArea.placeholder = '[{"en":"Hello","cn":"你好","t":0}]';
                actionBtn.onclick = parseTranscript;
            } else {
                modalTitle.innerText = "匯入單字";
                modalHint.innerText = '格式：[{ "word": "...", "def": "...", "pos": "n." }, ...]';
                inputArea.placeholder = '[{"word":"Example","def":"範例"}]';
                actionBtn.onclick = parseVocab;
            }
        }

        function closeModal() {
            modal.classList.add('hidden');
        }

        function parseJSON(str) {
            str = str.trim();
            if (!str.startsWith('[')) str = '[' + str + ']';
            return new Function("return " + str)();
        }

        function parseVideoUrl() {
            try {
                const input = inputArea.value.trim();
                let id = input;
                
                let m = input.match(/[?&]v=([^&]+)/);
                if (m) id = m[1];
                
                m = input.match(/youtu\.be\/([^?]+)/);
                if (m) id = m[1];
                
                id = id.split('&')[0].split('?')[0];
                
                if (id.length !== 11) throw new Error("無效的影片 ID");
                
                // Save to localStorage
                localStorage.setItem('videoId', id);
                
                console.log(`✅ 影片設定為: ${id}`);
                closeModal();
                
                // Initialize player with the new video ID
                initializePlayer(id);
            } catch (e) {
                console.error("錯誤: " + e.message);
            }
        }

        function parseTranscript() {
            try {
                const data = parseJSON(inputArea.value);
                if (!Array.isArray(data)) throw new Error("必須是陣列");
                transcriptData = data;
                localStorage.setItem('transcriptData', JSON.stringify(transcriptData));
                renderTranscript();
                closeModal();
            } catch (e) {
                console.error("格式錯誤: " + e.message);
            }
        }

        function parseVocab() {
            try {
                const data = parseJSON(inputArea.value);
                if (!Array.isArray(data)) throw new Error("必須是陣列");
                vocabData = data;
                localStorage.setItem('vocabData', JSON.stringify(vocabData));
                renderTranscript();
                renderVocab();
                closeModal();
            } catch (e) {
                console.error("格式錯誤: " + e.message);
            }
        }

        // Render Functions
        function renderTranscript() {
            const container = document.getElementById('transcript-content');
            if (transcriptData.length === 0) return;
            
            container.innerHTML = "";
            const sortedVocab = [...vocabData].sort((a,b) => b.word.length - a.word.length);

            transcriptData.forEach((seg, idx) => {
                let html = seg.en;
                
                // Highlight vocab
                sortedVocab.forEach(v => {
                    const roots = v.roots || [v.word];
                    const pattern = roots.map(r => r.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|');
                    const regex = new RegExp(`\\b(${pattern})\\b`, 'gi');
                    html = html.replace(regex, (m) => 
                        `<span class="vocab-word" data-id="${v.id || v.word}" 
                               onmouseenter="showCard(event, '${v.id || v.word}')" 
                               onmouseleave="hideCard()">${m}</span>`
                    );
                });

                const hasTime = typeof seg.t === 'number';
                const timeLabel = hasTime ? formatTime(seg.t) : 'Set';
                const timeClass = hasTime ? 'bg-green-50 text-green-700' : 'bg-slate-100 text-slate-600';

                container.innerHTML += `
                    <div class="mb-6" id="seg-${idx}">
                        <div class="flex gap-2 mb-2">
                            <button class="px-2 py-1 rounded border ${timeClass} text-xs" 
                                    onclick="jumpToTime(${hasTime ? seg.t : 'null'})">
                                ⏵ ${timeLabel}
                            </button>
                            <button class="px-2 py-1 rounded border border-blue-200 bg-blue-50 text-blue-700 text-xs" 
                                    onclick="captureTime(${idx})">
                                Capture
                            </button>
                            <button class="px-2 py-1 rounded border border-amber-200 bg-amber-50 text-amber-700 text-xs" 
                                    onclick="editSegment(${idx})">
                                <span class="material-symbols-outlined text-xs">edit</span> Edit
                            </button>
                        </div>
                        <p class="mb-2 text-slate-800 leading-relaxed" id="en-${idx}">${html}</p>
                        ${seg.cn ? `<p class="cn-text hidden text-slate-600 pl-4 border-l-4 border-blue-200 italic text-sm" id="cn-${idx}">${seg.cn}</p>` : ''}
                    </div>`;
            });
            
            applyTranslationState();
        }

        function renderVocab() {
            const list = document.getElementById('vocab-list');
            const count = document.getElementById('vocab-count');
            
            if (vocabData.length === 0) return;
            
            count.textContent = vocabData.length;
            list.innerHTML = "";
            
            [...vocabData].sort((a,b) => a.word.localeCompare(b.word)).forEach(v => {
                list.innerHTML += `
                    <li class="p-3 hover:bg-blue-50 cursor-pointer" 
                        onclick="scrollToVocab('${v.id || v.word}')">
                        <div class="font-bold text-sm">${v.word}</div>
                        <div class="text-xs text-slate-500">${v.def || ''}</div>
                    </li>`;
            });
        }

        // YouTube Player
        function onYouTubeIframeAPIReady() {
            youtubeAPIReady = true;
            console.log('YouTube API Ready');
            // Only initialize player if a valid video ID is set
            if (videoId && videoId.length === 11) {
                player = new YT.Player('player', {
                    height: '100%',
                    width: '100%',
                    videoId: videoId,
                    playerVars: { rel: 0, modestbranding: 1 },
                    events: {
                        onReady: () => {
                            playerReady = true;
                            player.setPlaybackRate(currentPlaybackSpeed);
                            console.log('YouTube Player Ready');
                        },
                        onStateChange: (event) => {
                            updatePlayPauseButton();
                        }
                    }
                });
            }
        }
        
        function initializePlayer(id) {
            // Initialize player with a specific video ID
            if (!id || id.length !== 11) return;
            videoId = id;
            localStorage.setItem('videoId', id);
            
            // Wait for YouTube API to be ready
            if (!youtubeAPIReady || typeof YT === 'undefined' || typeof YT.Player === 'undefined') {
                console.log('等待 YouTube API 載入...');
                setTimeout(() => initializePlayer(id), 200);
                return;
            }
            
            if (!player) {
                player = new YT.Player('player', {
                    height: '100%',
                    width: '100%',
                    videoId: videoId,
                    playerVars: { rel: 0, modestbranding: 1 },
                    events: {
                        onReady: () => {
                            playerReady = true;
                            player.setPlaybackRate(currentPlaybackSpeed);
                            console.log('YouTube Player Ready');
                        },
                        onStateChange: (event) => {
                            updatePlayPauseButton();
                        }
                    }
                });
            } else if (playerReady) {
                player.loadVideoById(videoId);
            }
        }

        function jumpToTime(seconds) {
            if (!player || !playerReady || typeof seconds !== 'number') return;
            player.seekTo(seconds, true);
            player.playVideo();
        }

        function captureTime(idx) {
            if (!player || !playerReady || !transcriptData[idx]) return;
            const t = Math.floor(player.getCurrentTime());
            transcriptData[idx].t = t;
            localStorage.setItem('transcriptData', JSON.stringify(transcriptData));
            renderTranscript();
        }

        function editSegment(idx) {
            const seg = transcriptData[idx];
            if (!seg) return;
            
            // Store current editing index
            window.currentEditIndex = idx;
            
            // Fill in the modal
            document.getElementById('edit-en-input').value = seg.en || '';
            document.getElementById('edit-cn-input').value = seg.cn || '';
            
            // Show modal
            document.getElementById('edit-modal').classList.remove('hidden');
            
            // Focus on English input
            setTimeout(() => {
                document.getElementById('edit-en-input').focus();
            }, 100);
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
            window.currentEditIndex = null;
        }

        function saveEdit() {
            const idx = window.currentEditIndex;
            if (idx === null || idx === undefined || !transcriptData[idx]) return;
            
            const enText = document.getElementById('edit-en-input').value.trim();
            const cnText = document.getElementById('edit-cn-input').value.trim();
            
            if (enText) {
                transcriptData[idx].en = enText;
            }
            
            transcriptData[idx].cn = cnText;
            
            localStorage.setItem('transcriptData', JSON.stringify(transcriptData));
            renderTranscript();
            closeEditModal();
        }

        function formatTime(sec) {
            if (typeof sec !== 'number' || sec < 0) return '00:00';
            const m = Math.floor(sec / 60);
            const s = Math.floor(sec % 60);
            return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        // Interaction
        function showCard(e, id) {
            const vocab = vocabData.find(v => (v.id === id) || (v.word === id));
            if (!vocab) return;
            
            floatingCard.innerHTML = `
                <div class="p-4">
                    <h3 class="text-xl font-bold mb-2">${vocab.word}</h3>
                    <div class="text-xs text-slate-500 mb-3">${vocab.pos || ''} ${vocab.ipa || ''}</div>
                    <p class="text-sm mb-3">${vocab.def}</p>
                    ${vocab.cn ? `<p class="text-xs text-blue-700 font-bold">${vocab.cn}</p>` : ''}
                </div>`;
            
            const rect = e.target.getBoundingClientRect();
            floatingCard.style.left = rect.left + 'px';
            floatingCard.style.top = (rect.bottom + 10) + 'px';
            floatingCard.classList.remove('hidden');
        }

        function hideCard() {
            floatingCard.classList.add('hidden');
        }

        function toggleTranslations() {
            translationsVisible = !translationsVisible;
            const toggleBtnText = document.getElementById('toggle-btn-text');
            const cnToggleText = document.getElementById('cn-toggle-text');
            
            if (toggleBtnText) {
                toggleBtnText.innerText = translationsVisible ? "Hide CN" : "Show CN";
            }
            if (cnToggleText) {
                cnToggleText.innerText = translationsVisible ? "隱藏" : "中文";
            }
            
            applyTranslationState();
        }

        function applyTranslationState() {
            document.querySelectorAll('.cn-text').forEach(el => {
                if (translationsVisible) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });
        }

        function scrollToVocab(id) {
            const span = document.querySelector(`.vocab-word[data-id="${id}"]`);
            if (span) {
                span.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function increaseFontSize() {
            if (currentFontSize < 32) {
                currentFontSize += 2;
                applyFontSize();
            }
        }

        function decreaseFontSize() {
            if (currentFontSize > 12) {
                currentFontSize -= 2;
                applyFontSize();
            }
        }

        function applyFontSize() {
            const transcriptContent = document.getElementById('transcript-content');
            if (transcriptContent) {
                transcriptContent.style.fontSize = currentFontSize + 'px';
            }
        }

        function increasePlaybackSpeed() {
            if (!player || !playerReady) return;
            const speeds = [0.25, 0.5, 0.75, 1.0, 1.25, 1.5, 1.75, 2.0];
            const currentIndex = speeds.indexOf(currentPlaybackSpeed);
            if (currentIndex < speeds.length - 1) {
                currentPlaybackSpeed = speeds[currentIndex + 1];
                player.setPlaybackRate(currentPlaybackSpeed);
                updateSpeedDisplay();
            }
        }

        function decreasePlaybackSpeed() {
            if (!player || !playerReady) return;
            const speeds = [0.25, 0.5, 0.75, 1.0, 1.25, 1.5, 1.75, 2.0];
            const currentIndex = speeds.indexOf(currentPlaybackSpeed);
            if (currentIndex > 0) {
                currentPlaybackSpeed = speeds[currentIndex - 1];
                player.setPlaybackRate(currentPlaybackSpeed);
                updateSpeedDisplay();
            }
        }

        function updateSpeedDisplay() {
            const display = document.getElementById('speed-display');
            if (display) {
                display.textContent = currentPlaybackSpeed.toFixed(2) + 'x';
            }
        }

        function togglePlayPause() {
            if (!player || !playerReady) return;
            
            const state = player.getPlayerState();
            const playIcon = document.getElementById('play-icon');
            const playText = document.getElementById('play-text');
            
            // YT.PlayerState: UNSTARTED (-1), ENDED (0), PLAYING (1), PAUSED (2), BUFFERING (3), CUED (5)
            if (state === 1) { // Playing
                player.pauseVideo();
                playIcon.textContent = 'play_arrow';
                playText.textContent = '播放';
            } else { // Paused or other states
                player.playVideo();
                playIcon.textContent = 'pause';
                playText.textContent = '暫停';
            }
        }

        function updatePlayPauseButton() {
            if (!player || !playerReady) return;
            const state = player.getPlayerState();
            const playIcon = document.getElementById('play-icon');
            const playText = document.getElementById('play-text');
            
            if (state === 1) { // Playing
                playIcon.textContent = 'pause';
                playText.textContent = '暫停';
            } else {
                playIcon.textContent = 'play_arrow';
                playText.textContent = '播放';
            }
        }

        function resetSettings() {
            currentFontSize = 18;
            applyFontSize();
            
            if (player && playerReady) {
                currentPlaybackSpeed = 1.0;
                player.setPlaybackRate(currentPlaybackSpeed);
                updateSpeedDisplay();
            }
            
            translationsVisible = false;
            const toggleBtnText = document.getElementById('toggle-btn-text');
            const cnToggleText = document.getElementById('cn-toggle-text');
            if (toggleBtnText) toggleBtnText.innerText = 'Show CN';
            if (cnToggleText) cnToggleText.innerText = '中文';
            applyTranslationState();
        }

        function changeVideoUrl() {
            const newUrl = prompt('貼上 YouTube 網址或影片 ID:', videoId);
            if (!newUrl || newUrl.trim() === '') return;
            
            try {
                let id = newUrl.trim();
                
                // 提取影片 ID
                let m = id.match(/[?&]v=([^&]+)/);
                if (m) id = m[1];
                
                m = id.match(/youtu\.be\/([^?]+)/);
                if (m) id = m[1];
                
                id = id.split('&')[0].split('?')[0];
                
                if (id.length !== 11) throw new Error("無效的影片 ID");
                
                videoId = id;
                if (player && playerReady) {
                    player.loadVideoById(videoId);
                    console.log(`✅ 影片已更換: ${videoId}`);
                }
            } catch (e) {
                console.error("錯誤: " + e.message);
            }
        }

        // Export Function
        function downloadHTML() {
            const clone = document.documentElement.cloneNode(true);
            
            // Remove action buttons
            const btns = clone.querySelector('#action-buttons');
            if (btns) btns.remove();

            // Remove all Five Server and third-party injected code
            const scriptsToRemove = clone.querySelectorAll('script[data-id="five-server"], script[id="www-widgetapi-script"]');
            scriptsToRemove.forEach(s => s.remove());
            
            // Remove all injected styles (Five Server, Tailwind compiled, third-party)
            const stylesToRemove = clone.querySelectorAll('style[id*="five"], style[class*="five"], style:not([type])');
            stylesToRemove.forEach(s => {
                const content = s.textContent || '';
                if (content.includes('five-server') || 
                    content.includes('fiveserver') || 
                    content.includes('keyword-info') ||
                    content.includes('tippy-') ||
                    content.includes('ubersuggest') ||
                    content.includes('bl-info') ||
                    content.includes('kw-info') ||
                    content.includes('statistics-graph') ||
                    content.includes('ue-sidebar') ||
                    content.includes('tw-border-spacing') ||
                    content.includes('tailwindcss v3.4')) {
                    s.remove();
                }
            });
            
            // Remove Ubersuggest/extension divs
            const extensionDivs = clone.querySelectorAll('.ue-sidebar-container, [class*="ubersuggest"]');
            extensionDivs.forEach(div => div.remove());

            let html = clone.outerHTML;

            // Inject data (keep videoId empty for exported files)
            html = html.replace(
                /let transcriptData = \[.*?\];/s,
                `let transcriptData = ${JSON.stringify(transcriptData)};`
            );
            html = html.replace(
                /let vocabData = \[.*?\];/s,
                `let vocabData = ${JSON.stringify(vocabData)};`
            );
            html = html.replace(
                /let videoId = .*?;/,
                `let videoId = localStorage.getItem('videoId') || '';`
            );

            // 確保 player 是空的 div，不要包含 iframe
            html = html.replace(
                /<iframe[^>]*id="player"[^>]*>[\s\S]*?<\/iframe>/,
                '<div id="player" class="absolute inset-0"></div>'
            );
            html = html.replace(
                /<div id="player"[^>]*>[\s\S]*?<\/div>/,
                '<div id="player" class="absolute inset-0"></div>'
            );

            // Remove Capture buttons from exported file
            html = html.replace(
                /<button[^>]*onclick="captureTime\([^)]+\)"[^>]*>[\s\S]*?Capture[\s\S]*?<\/button>/g,
                ''
            );
            
            // Remove captureTime function from exported file
            html = html.replace(
                /function captureTime\([^)]*\) \{[\s\S]*?\n        \}/,
                ''
            );
            
            // Update video section hint text
            html = html.replace(
                /點擊時間標籤跳轉，按 Capture 設定當前播放時間/,
                '點擊時間標籤跳轉到指定時間'
            );

            // Download
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'study_guide.html';
            a.click();
            URL.revokeObjectURL(url);

            console.log(`✅ 匯出成功！\n逐字稿: ${transcriptData.length} 段\n單字: ${vocabData.length} 個\n影片: 需透過「更換影片」按鈕設定`);
        }

        // Load YouTube API
        const tag = document.createElement('script');
        tag.src = 'https://www.youtube.com/iframe_api';
        document.head.appendChild(tag);

        // Global YouTube Ready handler
        window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;

        // Initialize if data exists
        if (transcriptData.length > 0 || vocabData.length > 0) {
            renderTranscript();
            renderVocab();
        }
    </script>
</body>
</html>
